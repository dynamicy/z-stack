###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                07/Jun/2010  09:05:35 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0- #
#                          1.4.0\ZStack-CC2530-2.3.0-1.4.0\Components\stack\n #
#                          wk\stub_aps.c                                      #
#    Command line       =  -f "D:\µ{¦¡¶}µo\TI Zigbee                          #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\Tools\CC2530DB\f8wCoord.cfg"       #
#                          (-DCPU32MHZ -DROOT=__near_func                     #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DZDO_COORDINATOR -DRTR_NWK -DBLINK_LEDS) -f       #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\Tools\CC253 #
#                          0DB\f8wConfig.cfg" (-DSECURE=0                     #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=TRUE      #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Components\stack\ #
#                          nwk\stub_aps.c" -D ZTOOL_P1 -D MT_TASK -D          #
#                          MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG  #
#                          -lC "D:\µ{¦¡¶}µo\TI Zigbee                         #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\CoordinatorKB\List\" -lA "D:\µ{¦¡¶}µo\TI    #
#                          Zigbee Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC #
#                          2530-2.3.0-1.4.0\Projects\zstack\Utilities\Locatio #
#                          nApp\CC2530DB\CoordinatorKB\List\"                 #
#                          --diag_suppress Pe001,Pa010 -o "D:\µ{¦¡¶}µo\TI     #
#                          Zigbee Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC #
#                          2530-2.3.0-1.4.0\Projects\zstack\Utilities\Locatio #
#                          nApp\CC2530DB\CoordinatorKB\Obj\" -e               #
#                          --require_prototypes --debug --core=plain          #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "D:\µ{¦¡¶}µo\TI Zigbee     #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\" -I "D:\µ{¦¡¶}µo\TI Zigbee                 #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\SOURCE\" -I "D:\µ{¦¡¶}µo\TI Zigbee       #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\ZMAIN\TI2530DB\" -I                #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MT\" -I "D:\µ{¦¡¶}µo\TI Zigbee               #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\HAL\INCLUDE\" -I  #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\HAL\TARGET\CC2530EB\" -I "D:\µ{¦¡¶}µo\TI     #
#                          Zigbee Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC #
#                          2530-2.3.0-1.4.0\Projects\zstack\Utilities\Locatio #
#                          nApp\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\MCU\C #
#                          CSOC\" -I "D:\µ{¦¡¶}µo\TI Zigbee                   #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\OSAL\INCLUDE\"    #
#                          -I "D:\µ{¦¡¶}µo\TI Zigbee                          #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\STACK\AF\" -I     #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\NWK\" -I "D:\µ{¦¡¶}µo\TI Zigbee        #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\STACK\SEC\" -I    #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\SAPI\" -I "D:\µ{¦¡¶}µo\TI Zigbee       #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\STACK\SYS\" -I    #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\ZDO\" -I "D:\µ{¦¡¶}µo\TI Zigbee        #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\ZMAC\F8W\" -I     #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\ZMAC\" -I "D:\µ{¦¡¶}µo\TI Zigbee             #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SADDR\"  #
#                          -I "D:\µ{¦¡¶}µo\TI Zigbee                          #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SDATA\"  #
#                          -I "D:\µ{¦¡¶}µo\TI Zigbee                          #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\MAC\INCLUDE\" -I  #
#                          "D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0 #
#                          -1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\U #
#                          tilities\LocationApp\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MAC\HIGH_LEVEL\" -I "D:\µ{¦¡¶}µo\TI Zigbee   #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_LEVEL\srf #
#                          04\" -I "D:\µ{¦¡¶}µo\TI Zigbee                     #
#                          Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2. #
#                          3.0-1.4.0\Projects\zstack\Utilities\LocationApp\CC #
#                          2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_LEVEL\srf #
#                          04\SINGLE_CHIP\" -I "C:\IAR Systems\Embedded       #
#                          Workbench 5.3\8051\INC\" -I "C:\IAR                #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\"     #
#                          -Ohz                                               #
#    List file          =  D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0- #
#                          1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\Ut #
#                          ilities\LocationApp\CC2530DB\CoordinatorKB\List\st #
#                          ub_aps.lst                                         #
#    Object file        =  D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0- #
#                          1.4.0\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\Ut #
#                          ilities\LocationApp\CC2530DB\CoordinatorKB\Obj\stu #
#                          b_aps.r51                                          #
#                                                                             #
#                                                                             #
###############################################################################

D:\µ{¦¡¶}µo\TI Zigbee Z-Stack\ZStack-CC2530-2.3.0-1.4.0\ZStack-CC2530-2.3.0-1.4.0\Components\stack\nwk\stub_aps.c
      1          /**************************************************************************************************
      2            Filename:       stub_aps.c
      3            Revised:        $Date: 2008-1-04 13:13:13 -0700 (Fri, 04 Jan 2008) $
      4            Revision:       $Revision: 1 $
      5          
      6            Description:    Stub APS processing functions
      7          
      8          
      9            Copyright 2008 - 2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41           * INCLUDES
     42           */
     43          #include "osal.h"
     44          #include "mac_spec.h"
     45          #include "nwk_util.h"
     46          #include "AF.h"
     47          
     48          #include "stub_aps.h"
     49          
     50          /*********************************************************************
     51           * MACROS
     52           */
     53          
     54          /*********************************************************************
     55           * CONSTANTS
     56           */
     57          
     58          // Stub NWK header length
     59          #define STUB_NWK_HDR_LEN                2
     60          
     61          // Start of the Stub APS header in the Inter-PAN frame
     62          #define STUB_APS_HDR_FRAME_CTRL         STUB_NWK_HDR_LEN
     63          
     64          // Stub APS event identifiers
     65          #define CHANNEL_CHANGE_EVT              0x0001
     66          
     67          #define CHANNEL_CHANGE_RETRY_TIMEOUT    100
     68          
     69          /*********************************************************************
     70           * TYPEDEFS
     71           */
     72          typedef struct
     73          {
     74            zAddrType_t addr;
     75            uint16 panId;
     76          } pan_t;
     77          
     78          /*********************************************************************
     79           * GLOBAL VARIABLES
     80           */
     81          

   \                                 In  segment XDATA_I, align 1, keep-with-next
     82          uint8 StubAPS_TaskID = 0xFF;    // Task ID for internal task/event processing
   \                     StubAPS_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE `?<Initializer for StubAPS_TaskID>`
   \   000001                REQUIRE __INIT_XDATA_I
     83          
     84          /*********************************************************************
     85           * EXTERNAL VARIABLES
     86           */
     87          
     88          
     89          /*********************************************************************
     90           * EXTERNAL FUNCTIONS
     91           */
     92          
     93          
     94          /*********************************************************************
     95           * LOCAL VARIABLES
     96           */
     97          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     98          static uint8 newChannel;
   \                     newChannel:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     99          static uint8 channelChangeInProgress = FALSE;
   \                     channelChangeInProgress:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    100          
    101          // Application info

   \                                 In  segment XDATA_I, align 1, keep-with-next
    102          static uint8 appTaskID = 0xFF;  // Application task id
   \                     appTaskID:
   \   000000                DS 1
   \   000001                REQUIRE `?<Initializer for appTaskID>`
   \   000001                REQUIRE __INIT_XDATA_I

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    103          static uint8 appEndPoint = 0;   // Application endpoint
   \                     appEndPoint:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    104          
    105          
    106          /*********************************************************************
    107           * LOCAL FUNCTIONS
    108           */
    109          
    110          static void StubNWK_ParseMsg( uint8 *buf, uint8 bufLength, NLDE_FrameFormat_t *snff );
    111          static void StubAPS_ParseMsg( NLDE_FrameFormat_t *snff, aps_FrameFormat_t *saff );
    112          static void StubNWK_BuildMsg( uint8 *nwkHdr );
    113          static void StubAPS_BuildMsg( uint8 *apsHdr, uint8 frmCtrl, uint16 groupID, APSDE_DataReq_t *req );
    114          static ZStatus_t StubAPS_BuildFrameControl( uint8 *frmCtrl, zAddrType_t *dstAddr, 
    115                                                      uint16 *groupID, APSDE_DataReq_t *req );
    116          static ZStatus_t StubAPS_SetNewChannel( uint8 channel );
    117          static void StubAPS_NotifyApp( uint8 status );
    118          
    119          uint8 StubAPS_ZMacCallback( uint8 *msgPtr );
    120          
    121          /*********************************************************************
    122           * @fn      StubAPS_Init()
    123           *
    124           * @brief   Initialize stub APS layer
    125           *
    126           * @param   task_id - Task identifier for the desired task
    127           *
    128           * @return  none
    129           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    130          void StubAPS_Init( uint8 task_id )
   \                     StubAPS_Init:
    131          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    132            StubAPS_TaskID = task_id;
   \   000004   E9           MOV     A,R1
   \   000005   90....       MOV     DPTR,#StubAPS_TaskID
   \   000008   F0           MOVX    @DPTR,A
    133              
    134            // register with ZMAC
    135            pZMac_AppCallback = StubAPS_ZMacCallback;
   \   000009   90....       MOV     DPTR,#pZMac_AppCallback
   \   00000C   74..         MOV     A,#(??StubAPS_ZMacCallback?relay & 0xff)
   \   00000E   F0           MOVX    @DPTR,A
   \   00000F   A3           INC     DPTR
   \   000010   74..         MOV     A,#((??StubAPS_ZMacCallback?relay >> 8) & 0xff)
   \   000012   F0           MOVX    @DPTR,A
    136            
    137          } /* StubAPS_Init() */
   \   000013   02....       LJMP    ??Subroutine21_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine21_0:
   \   000000   D083         POP     DPH
   \   000002   D082         POP     DPL
   \   000004   02....       LJMP    ?BRET
    138          
    139          /*********************************************************************
    140           * @fn      StubAPS_ProcessEvent()
    141           *
    142           * @brief   Main event loop for Stub APS task. This function should be called
    143           *          at periodic intervals when event occur.
    144           *
    145           * @param   task_id - Task ID
    146           * @param   events  - Bitmap of events
    147           *
    148           * @return  none
    149           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    150          UINT16 StubAPS_ProcessEvent( uint8 task_id, uint16 events )
   \                     StubAPS_ProcessEvent:
    151          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV     A,#-0x1
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 0,R2
   \   00000C   8B..         MOV     ?V0 + 1,R3
    152            (void)task_id; // Intentionally unreferenced parameter
    153            
    154            if ( events & SYS_EVENT_MSG )
   \   00000E   7480         MOV     A,#-0x80
   \   000010   55..         ANL     A,?V0 + 1
   \   000012   F9           MOV     R1,A
   \   000013   E4           CLR     A
   \   000014   7001         JNZ     ??StubAPS_ProcessEvent_0
   \   000016   E9           MOV     A,R1
   \                     ??StubAPS_ProcessEvent_0:
   \   000017   704D         JNZ     ??StubAPS_ProcessEvent_1
    155            {
    156              osal_event_hdr_t *msg_ptr;
    157          
    158              while ( (msg_ptr = (osal_event_hdr_t *)osal_msg_receive( StubAPS_TaskID )) != NULL )
    159              {
    160                if ( msg_ptr->event == MAC_MCPS_DATA_CNF )
    161                {
    162                  INTERP_DataConfirm( (ZMacDataCnf_t *)msg_ptr );
    163                }
    164                else if ( msg_ptr->event == MAC_MCPS_DATA_IND )
    165                {
    166                  INTERP_DataIndication( (macMcpsDataInd_t *)msg_ptr );
    167                }
    168                
    169                osal_msg_deallocate( (uint8 *)msg_ptr );
    170              }
    171              
    172              // Return unproccessed events
    173              return ( events ^ SYS_EVENT_MSG );
    174            }
    175          
    176            if ( events & CHANNEL_CHANGE_EVT )
   \   000019   EA           MOV     A,R2
   \   00001A   A2E0         MOV     C,0xE0 /* A   */.0
   \   00001C   5079         JNC     ??StubAPS_ProcessEvent_2
    177            {
    178              // try to change to the new channel
    179              ZStatus_t status = StubAPS_SetNewChannel( newChannel );
   \   00001E                ; Setup parameters for call to function StubAPS_SetNewChannel
   \   00001E   90....       MOV     DPTR,#newChannel
   \   000021   E0           MOVX    A,@DPTR
   \   000022   F9           MOV     R1,A
   \   000023   12....       LCALL   ??StubAPS_SetNewChannel?relay
   \   000026   E9           MOV     A,R1
   \   000027   FE           MOV     R6,A
    180              if ( status != ZSuccess )
   \   000028   6003         JZ      ??CrossCallReturnLabel_0
    181              {
    182                // turn MAC receiver back on
    183                uint8 rxOnIdle = true;
   \   00002A   12....       LCALL   ?Subroutine1 & 0xFFFF
    184                ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    185             
    186                // set NWK task to run
    187                nwk_setStateIdle( FALSE );
    188                
    189                channelChangeInProgress = FALSE;
    190              }
    191              
    192              // notify the application
    193              StubAPS_NotifyApp( status );
   \                     ??CrossCallReturnLabel_0:
   \   00002D                ; Setup parameters for call to function osal_msg_allocate
   \   00002D   7A02         MOV     R2,#0x2
   \   00002F   7B00         MOV     R3,#0x0
   \   000031   12....       LCALL   ??osal_msg_allocate?relay
   \   000034   EA           MOV     A,R2
   \   000035   7001         JNZ     ??StubAPS_ProcessEvent_3
   \   000037   EB           MOV     A,R3
   \                     ??StubAPS_ProcessEvent_3:
   \   000038   6012         JZ      ??StubAPS_ProcessEvent_4
   \   00003A   7433         MOV     A,#0x33
   \   00003C   8A82         MOV     DPL,R2
   \   00003E   8B83         MOV     DPH,R3
   \   000040   F0           MOVX    @DPTR,A
   \   000041   EE           MOV     A,R6
   \   000042   A3           INC     DPTR
   \   000043   F0           MOVX    @DPTR,A
   \   000044                ; Setup parameters for call to function osal_msg_send
   \   000044   90....       MOV     DPTR,#appTaskID
   \   000047   E0           MOVX    A,@DPTR
   \   000048   F9           MOV     R1,A
   \   000049   12....       LCALL   ??osal_msg_send?relay
    194              
    195              return ( events ^ CHANNEL_CHANGE_EVT );
   \                     ??StubAPS_ProcessEvent_4:
   \   00004C   7401         MOV     A,#0x1
   \   00004E   65..         XRL     A,?V0 + 0
   \   000050   FA           MOV     R2,A
   \   000051   AB..         MOV     R3,?V0 + 1
   \   000053   8046         SJMP    ??StubAPS_ProcessEvent_5
    196            }
   \                     ??StubAPS_ProcessEvent_6:
   \   000055   740D         MOV     A,#0xd
   \   000057   6A           XRL     A,R2
   \   000058   7005         JNZ     ??StubAPS_ProcessEvent_7
   \   00005A                ; Setup parameters for call to function INTERP_DataIndication
   \   00005A   EE           MOV     A,R6
   \   00005B   FA           MOV     R2,A
   \   00005C   12....       LCALL   ??INTERP_DataIndication?relay
   \                     ??StubAPS_ProcessEvent_7:
   \   00005F                ; Setup parameters for call to function osal_msg_deallocate
   \   00005F   EE           MOV     A,R6
   \   000060   FA           MOV     R2,A
   \   000061   EF           MOV     A,R7
   \   000062   FB           MOV     R3,A
   \   000063   12....       LCALL   ??osal_msg_deallocate?relay
   \                     ??StubAPS_ProcessEvent_1:
   \   000066                ; Setup parameters for call to function osal_msg_receive
   \   000066   90....       MOV     DPTR,#StubAPS_TaskID
   \   000069   E0           MOVX    A,@DPTR
   \   00006A   F9           MOV     R1,A
   \   00006B   12....       LCALL   ??osal_msg_receive?relay
   \   00006E   8A..         MOV     ?V0 + 2,R2
   \   000070   8B..         MOV     ?V0 + 3,R3
   \   000072   AE..         MOV     R6,?V0 + 2
   \   000074   AF..         MOV     R7,?V0 + 3
   \   000076   EE           MOV     A,R6
   \   000077   7001         JNZ     ??StubAPS_ProcessEvent_8
   \   000079   EF           MOV     A,R7
   \                     ??StubAPS_ProcessEvent_8:
   \   00007A   6012         JZ      ??StubAPS_ProcessEvent_9
   \   00007C   8E82         MOV     DPL,R6
   \   00007E   8F83         MOV     DPH,R7
   \   000080   E0           MOVX    A,@DPTR
   \   000081   FA           MOV     R2,A
   \   000082   740C         MOV     A,#0xc
   \   000084   6A           XRL     A,R2
   \   000085   70CE         JNZ     ??StubAPS_ProcessEvent_6
   \   000087                ; Setup parameters for call to function INTERP_DataConfirm
   \   000087   EE           MOV     A,R6
   \   000088   FA           MOV     R2,A
   \   000089   12....       LCALL   ??INTERP_DataConfirm?relay
   \   00008C   80D1         SJMP    ??StubAPS_ProcessEvent_7
   \                     ??StubAPS_ProcessEvent_9:
   \   00008E   AA..         MOV     R2,?V0 + 0
   \   000090   7480         MOV     A,#-0x80
   \   000092   65..         XRL     A,?V0 + 1
   \   000094   FB           MOV     R3,A
   \   000095   8004         SJMP    ??StubAPS_ProcessEvent_5
    197            
    198            // If reach here, the events are unknown
    199            // Discard or make more handlers
    200            return 0;
   \                     ??StubAPS_ProcessEvent_2:
   \   000097   7A00         MOV     R2,#0x0
   \   000099   7B00         MOV     R3,#0x0
   \                     ??StubAPS_ProcessEvent_5:
   \   00009B   7401         MOV     A,#0x1
   \   00009D   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000A0   7F04         MOV     R7,#0x4
   \   0000A2   02....       LJMP    ?BANKED_LEAVE_XDATA
    201          
    202          } /* StubAPS_ProcessEvent() */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine13:
   \   000000   85..82       MOV     DPL,?XSP + 0
   \   000003   85..83       MOV     DPH,?XSP + 1
   \   000006   F0           MOVX    @DPTR,A
   \   000007                ; Setup parameters for call to function ZMacSetReq
   \   000007                ; Setup parameters for call to function ZMacSetReq
   \   000007                ; Setup parameters for call to function ZMacSetReq
   \   000007                ; Setup parameters for call to function ZMacSetReq
   \   000007                ; Setup parameters for call to function ZMacSetReq
   \   000007   AA82         MOV     R2,DPL
   \   000009   AB83         MOV     R3,DPH
   \   00000B   7952         MOV     R1,#0x52
   \   00000D   12....       LCALL   ??ZMacSetReq?relay
   \   000010   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7401         MOV     A,#0x1
   \   000002   12....       LCALL   ?Subroutine13 & 0xFFFF
   \                     ??CrossCallReturnLabel_38:
   \   000005                ; Setup parameters for call to function nwk_setStateIdle
   \   000005                ; Setup parameters for call to function nwk_setStateIdle
   \   000005   7900         MOV     R1,#0x0
   \   000007   12....       LCALL   ??nwk_setStateIdle?relay
   \   00000A   E4           CLR     A
   \   00000B   90....       MOV     DPTR,#channelChangeInProgress
   \   00000E   F0           MOVX    @DPTR,A
   \   00000F   22           RET
    203          
    204          
    205          /*********************************************************************
    206           * @fn          StubNWK_ParseMsg
    207           *
    208           * @brief       Call this function to parse an incoming Stub NWK frame.
    209           *
    210           * @param       buf - pointer incoming message buffer
    211           * @param       bufLength - length of incoming message
    212           * @param       snff  - pointer Frame Format Parameters
    213           *
    214           * @return      pointer to network packet, NULL if error
    215           */
    216          static void StubNWK_ParseMsg( uint8 *buf, uint8 bufLength, NLDE_FrameFormat_t *snff )
    217          {
    218            uint16 fc;
    219          
    220            osal_memset( snff, 0, sizeof(NLDE_FrameFormat_t) );
    221            
    222            snff->bufLength = bufLength;
    223          
    224            // get the frame control
    225            fc = BUILD_UINT16( buf[NWK_HDR_FRAME_CTRL_LSB], buf[NWK_HDR_FRAME_CTRL_MSB] );
    226            
    227            // parse the frame control
    228            NLDE_ParseFrameControl( fc, snff );
    229            
    230            snff->hdrLen = STUB_NWK_HDR_LEN;
    231            
    232            // Stub NWK payload
    233            snff->nsdu = buf + snff->hdrLen;
    234            snff->nsduLength = snff->bufLength - snff->hdrLen;
    235          
    236          } /* StubNWK_ParseMsg */
    237          
    238          /*********************************************************************
    239           * @fn          StubAPS_ParseMsg
    240           *
    241           * @brief       Call this function to parse an incoming Stub APS frame.
    242           *
    243           * @param       naff  - pointer Stub NWK Frame Format Parameters
    244           * @param       saff  - pointer Stub APS Format Parameters
    245           *
    246           * @return      none
    247           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    248          static void StubAPS_ParseMsg( NLDE_FrameFormat_t *snff, aps_FrameFormat_t *saff )
   \                     StubAPS_ParseMsg:
    249          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   \   000009   EC           MOV     A,R4
   \   00000A   FE           MOV     R6,A
   \   00000B   ED           MOV     A,R5
   \   00000C   FF           MOV     R7,A
    250            uint8 fcb;
    251            uint8 *asdu;
    252            
    253            osal_memset( saff, 0, sizeof(aps_FrameFormat_t) );
   \   00000D                ; Setup parameters for call to function osal_memset
   \   00000D   7C15         MOV     R4,#0x15
   \   00000F   7D00         MOV     R5,#0x0
   \   000011   7900         MOV     R1,#0x0
   \   000013   EE           MOV     A,R6
   \   000014   FA           MOV     R2,A
   \   000015   EF           MOV     A,R7
   \   000016   FB           MOV     R3,A
   \   000017   12....       LCALL   ??osal_memset?relay
    254            
    255            saff->asduLength = snff->nsduLength;
   \   00001A   EE           MOV     A,R6
   \   00001B   2410         ADD     A,#0x10
   \   00001D   F8           MOV     R0,A
   \   00001E   EF           MOV     A,R7
   \   00001F   3400         ADDC    A,#0x0
   \   000021   F9           MOV     R1,A
   \   000022   E8           MOV     A,R0
   \   000023   FA           MOV     R2,A
   \   000024   E9           MOV     A,R1
   \   000025   FB           MOV     R3,A
   \   000026   E5..         MOV     A,?V0 + 0
   \   000028   2417         ADD     A,#0x17
   \   00002A   F8           MOV     R0,A
   \   00002B   E5..         MOV     A,?V0 + 1
   \   00002D   3400         ADDC    A,#0x0
   \   00002F   F9           MOV     R1,A
   \   000030   E8           MOV     A,R0
   \   000031   FC           MOV     R4,A
   \   000032   E9           MOV     A,R1
   \   000033   FD           MOV     R5,A
   \   000034   8C82         MOV     DPL,R4
   \   000036   8D83         MOV     DPH,R5
   \   000038   12....       LCALL   ??Subroutine19_0 & 0xFFFF
    256            asdu = snff->nsdu;
   \                     ??CrossCallReturnLabel_31:
   \   00003B   E5..         MOV     A,?V0 + 0
   \   00003D   241D         ADD     A,#0x1d
   \   00003F   F8           MOV     R0,A
   \   000040   E5..         MOV     A,?V0 + 1
   \   000042   3400         ADDC    A,#0x0
   \   000044   F9           MOV     R1,A
   \   000045   88..         MOV     ?V0 + 2,R0
   \   000047   89..         MOV     ?V0 + 3,R1
   \   000049   8882         MOV     DPL,R0
   \   00004B   F583         MOV     DPH,A
   \   00004D   12....       LCALL   ??Subroutine22_0 & 0xFFFF
    257            saff->macDestAddr = snff->macDstAddr;
   \                     ??CrossCallReturnLabel_39:
   \   000050   E5..         MOV     A,?V0 + 0
   \   000052   240D         ADD     A,#0xd
   \   000054   F582         MOV     DPL,A
   \   000056   E5..         MOV     A,?V0 + 1
   \   000058   12....       LCALL   ?Subroutine10 & 0xFFFF
   \                     ??CrossCallReturnLabel_13:
   \   00005B   8E82         MOV     DPL,R6
   \   00005D   8F83         MOV     DPH,R7
   \   00005F   A3           INC     DPTR
   \   000060   A3           INC     DPTR
   \   000061   A3           INC     DPTR
   \   000062   A3           INC     DPTR
   \   000063   A3           INC     DPTR
   \   000064   A3           INC     DPTR
   \   000065   A3           INC     DPTR
   \   000066   A3           INC     DPTR
   \   000067   A3           INC     DPTR
   \   000068   A3           INC     DPTR
   \   000069   E5..         MOV     A,?V0 + 0
   \   00006B   F0           MOVX    @DPTR,A
   \   00006C   A3           INC     DPTR
   \   00006D   E5..         MOV     A,?V0 + 1
   \   00006F   F0           MOVX    @DPTR,A
    258            
    259            // First byte is Frame Control.
    260            saff->FrmCtrl = *asdu++;
   \   000070   8882         MOV     DPL,R0
   \   000072   8983         MOV     DPH,R1
   \   000074   E0           MOVX    A,@DPTR
   \   000075   F5..         MOV     ?V0 + 0,A
   \   000077   8E82         MOV     DPL,R6
   \   000079   8F83         MOV     DPH,R7
   \   00007B   F0           MOVX    @DPTR,A
   \   00007C   8882         MOV     DPL,R0
   \   00007E   8983         MOV     DPH,R1
   \   000080   A3           INC     DPTR
   \   000081   A882         MOV     R0,DPL
   \   000083   A983         MOV     R1,DPH
    261          
    262            fcb = saff->FrmCtrl & APS_FRAME_TYPE_MASK;
    263            if ( fcb == STUB_APS_FRAME )
   \   000085   7403         MOV     A,#0x3
   \   000087   55..         ANL     A,?V0 + 0
   \   000089   6403         XRL     A,#0x3
   \   00008B   7033         JNZ     ??CrossCallReturnLabel_22
    264            {
    265              fcb = saff->FrmCtrl & APS_DELIVERYMODE_MASK;
   \   00008D   740C         MOV     A,#0xc
   \   00008F   55..         ANL     A,?V0 + 0
   \   000091   F5..         MOV     ?V0 + 0,A
    266              if ( fcb == APS_FC_DM_BROADCAST )
   \   000093   EE           MOV     A,R6
   \   000094   240C         ADD     A,#0xc
   \   000096   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_15:
   \   000099   7408         MOV     A,#0x8
   \   00009B   65..         XRL     A,?V0 + 0
   \   00009D   7005         JNZ     ??StubAPS_ParseMsg_0
    267                saff->wasBroadcast = true;
   \   00009F   7401         MOV     A,#0x1
   \   0000A1   F0           MOVX    @DPTR,A
   \   0000A2   800E         SJMP    ??CrossCallReturnLabel_23
    268              else
    269                saff->wasBroadcast = false;
   \                     ??StubAPS_ParseMsg_0:
   \   0000A4   E4           CLR     A
   \   0000A5   F0           MOVX    @DPTR,A
    270              
    271              if ( fcb == APS_FC_DM_GROUP )
   \   0000A6   740C         MOV     A,#0xc
   \   0000A8   65..         XRL     A,?V0 + 0
   \   0000AA   7006         JNZ     ??CrossCallReturnLabel_23
    272              {
    273                saff->GroupID = BUILD_UINT16( asdu[0], asdu[1] );
   \   0000AC   12....       LCALL   ?Subroutine4 & 0xFFFF
    274                asdu += sizeof( uint16 );
    275              }
   \                     ??CrossCallReturnLabel_4:
   \   0000AF   12....       LCALL   ??Subroutine17_0 & 0xFFFF
    276              
    277              // Pull out the Cluster ID
    278              saff->ClusterID = BUILD_UINT16( asdu[0], asdu[1] );
   \                     ??CrossCallReturnLabel_23:
   \   0000B2   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_5:
   \   0000B5   12....       LCALL   ?Subroutine0 & 0xFFFF
    279              asdu += sizeof( uint16 );
    280          
    281              // Pull out the profile ID
    282              saff->ProfileID = BUILD_UINT16( asdu[0], asdu[1] );
   \                     ??CrossCallReturnLabel_21:
   \   0000B8   12....       LCALL   ?Subroutine4 & 0xFFFF
    283              asdu += 2;
    284            }
   \                     ??CrossCallReturnLabel_6:
   \   0000BB   A3           INC     DPTR
   \   0000BC   A3           INC     DPTR
   \   0000BD   12....       LCALL   ?Subroutine0 & 0xFFFF
    285            
    286            saff->asdu = asdu;
   \                     ??CrossCallReturnLabel_22:
   \   0000C0   EE           MOV     A,R6
   \   0000C1   240E         ADD     A,#0xe
   \   0000C3   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_16:
   \   0000C6   E8           MOV     A,R0
   \   0000C7   F0           MOVX    @DPTR,A
   \   0000C8   A3           INC     DPTR
   \   0000C9   E9           MOV     A,R1
   \   0000CA   F0           MOVX    @DPTR,A
    287            saff->asduLength -= (uint8) (asdu - snff->nsdu);
   \   0000CB   85..82       MOV     DPL,?V0 + 2
   \   0000CE   85..83       MOV     DPH,?V0 + 3
   \   0000D1   E0           MOVX    A,@DPTR
   \   0000D2   F5..         MOV     ?V0 + 0,A
   \   0000D4   8A82         MOV     DPL,R2
   \   0000D6   8B83         MOV     DPH,R3
   \   0000D8   E0           MOVX    A,@DPTR
   \   0000D9   C3           CLR     C
   \   0000DA   98           SUBB    A,R0
   \   0000DB   25..         ADD     A,?V0 + 0
   \   0000DD   F5..         MOV     ?V0 + 0,A
   \   0000DF   F0           MOVX    @DPTR,A
    288            saff->apsHdrLen = snff->nsduLength - saff->asduLength;
   \   0000E0   8C82         MOV     DPL,R4
   \   0000E2   8D83         MOV     DPH,R5
   \   0000E4   E0           MOVX    A,@DPTR
   \   0000E5   C3           CLR     C
   \   0000E6   95..         SUBB    A,?V0 + 0
   \   0000E8   C0E0         PUSH    A
   \   0000EA   EE           MOV     A,R6
   \   0000EB   240D         ADD     A,#0xd
   \   0000ED   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_17:
   \   0000F0   D0E0         POP     A
   \   0000F2   F0           MOVX    @DPTR,A
    289            
    290          } /* StubAPS_ParseMsg */
   \   0000F3   7F06         MOV     R7,#0x6
   \   0000F5   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   8882         MOV     DPL,R0
   \   000002   8983         MOV     DPH,R1
   \   000004   E0           MOVX    A,@DPTR
   \   000005   F5..         MOV     ?V0 + 4,A
   \   000007   A3           INC     DPTR
   \   000008   E0           MOVX    A,@DPTR
   \   000009   F5..         MOV     ?V0 + 1,A
   \   00000B   E5..         MOV     A,?V0 + 4
   \   00000D   8E82         MOV     DPL,R6
   \   00000F   8F83         MOV     DPH,R7
   \   000011   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   A3           INC     DPTR
   \   000001   A3           INC     DPTR
   \   000002                REQUIRE ??Subroutine17_0
   \   000002                ; // Fall through to label ??Subroutine17_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine17_0:
   \   000000   A3           INC     DPTR
   \   000001   A3           INC     DPTR
   \   000002   A3           INC     DPTR
   \   000003   A3           INC     DPTR
   \   000004   F0           MOVX    @DPTR,A
   \   000005   A3           INC     DPTR
   \   000006   E5..         MOV     A,?V0 + 1
   \   000008   F0           MOVX    @DPTR,A
   \   000009   E8           MOV     A,R0
   \   00000A   2402         ADD     A,#0x2
   \   00000C   08           INC     R0
   \   00000D   08           INC     R0
   \   00000E   E9           MOV     A,R1
   \   00000F   3400         ADDC    A,#0x0
   \   000011   F9           MOV     R1,A
   \   000012   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine10:
   \   000000   3400         ADDC    A,#0x0
   \   000002   F583         MOV     DPH,A
   \   000004   E0           MOVX    A,@DPTR
   \   000005   F5..         MOV     ?V0 + 0,A
   \   000007   A3           INC     DPTR
   \   000008   E0           MOVX    A,@DPTR
   \   000009   F5..         MOV     ?V0 + 1,A
   \   00000B   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine19_0:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   8A82         MOV     DPL,R2
   \   000003   8B83         MOV     DPH,R3
   \   000005   F0           MOVX    @DPTR,A
   \   000006   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine22_0:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   A3           INC     DPTR
   \   000003   E0           MOVX    A,@DPTR
   \   000004   F9           MOV     R1,A
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine12:
   \   000000   F582         MOV     DPL,A
   \   000002   EF           MOV     A,R7
   \   000003   3400         ADDC    A,#0x0
   \   000005   F583         MOV     DPH,A
   \   000007   22           RET
    291          
    292          /******************************************************************************
    293           * @fn          StubAPS_BuildFrameControl
    294           *
    295           * @brief       This function builds Stub APS Frame Control and the destination
    296           *              address parameter for the MCPS-DATA Request.
    297           *
    298           * @param       frmCtrl - frame control
    299           * @param       dstAddr - destination address for MCPS-DATA Request
    300           * @param       groupID - group id
    301           * @param       req - APSDE_DataReq_t
    302           *
    303           * @return      ZStatus_t
    304           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    305          static ZStatus_t StubAPS_BuildFrameControl( uint8 *frmCtrl, zAddrType_t *dstAddr, 
   \                     StubAPS_BuildFrameControl:
    306                                                      uint16 *groupID, APSDE_DataReq_t *req )
    307          { 
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
   \   000009   EC           MOV     A,R4
   \   00000A   FA           MOV     R2,A
   \   00000B   ED           MOV     A,R5
   \   00000C   FB           MOV     R3,A
   \   00000D   740D         MOV     A,#0xd
   \   00000F   12....       LCALL   ?XSTACK_DISP0_8
   \   000012   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_9:
   \   000015   740F         MOV     A,#0xf
   \   000017   12....       LCALL   ?XSTACK_DISP0_8
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   FC           MOV     R4,A
   \   00001C   A3           INC     DPTR
   \   00001D   E0           MOVX    A,@DPTR
   \   00001E   FD           MOV     R5,A
    308            // Security
    309            if ( req->txOptions & APS_TX_OPTIONS_SECURITY_ENABLE )
   \   00001F   EC           MOV     A,R4
   \   000020   2415         ADD     A,#0x15
   \   000022   F582         MOV     DPL,A
   \   000024   ED           MOV     A,R5
   \   000025   12....       LCALL   ??Subroutine18_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_24:
   \   000028   F8           MOV     R0,A
   \   000029   A2E0         MOV     C,0xE0 /* A   */.0
   \   00002B   5005         JNC     ??StubAPS_BuildFrameControl_0
    310              return ( ZApsNotSupported );
   \                     ??StubAPS_BuildFrameControl_1:
   \   00002D   79B6         MOV     R1,#-0x4a
   \   00002F   02....       LJMP    ??StubAPS_BuildFrameControl_2 & 0xFFFF
    311              
    312            // Ack request
    313            if ( req->txOptions & APS_TX_OPTIONS_ACK )
   \                     ??StubAPS_BuildFrameControl_0:
   \   000032   5404         ANL     A,#0x4
   \   000034   70F7         JNZ     ??StubAPS_BuildFrameControl_1
    314              return ( ZApsNotSupported );
    315            
    316             // Fragmentation
    317            if ( req->txOptions & APS_TX_OPTIONS_PERMIT_FRAGMENT )
   \   000036   E8           MOV     A,R0
   \   000037   5408         ANL     A,#0x8
   \   000039   70F2         JNZ     ??StubAPS_BuildFrameControl_1
    318              return ( ZApsNotSupported );
    319            
    320            // set delivery mode
    321            if ( req->dstAddr.addrMode == AddrNotPresent )
   \   00003B   EC           MOV     A,R4
   \   00003C   2408         ADD     A,#0x8
   \   00003E   F8           MOV     R0,A
   \   00003F   ED           MOV     A,R5
   \   000040   3400         ADDC    A,#0x0
   \   000042   F9           MOV     R1,A
   \   000043   8882         MOV     DPL,R0
   \   000045   8983         MOV     DPH,R1
   \   000047   E0           MOVX    A,@DPTR
   \   000048   60E3         JZ      ??StubAPS_BuildFrameControl_1
    322              return ( ZApsNotSupported ); // No REFLECTOR
    323          
    324            // set frame type
    325            *frmCtrl = STUB_APS_FRAME;
   \   00004A   7403         MOV     A,#0x3
   \   00004C   8E82         MOV     DPL,R6
   \   00004E   8F83         MOV     DPH,R7
   \   000050   F0           MOVX    @DPTR,A
    326            
    327            // set DstAddrMode of MCPS-DATA Request to DstAddrMode of INTERP-Data Request
    328            dstAddr->addrMode = req->dstAddr.addrMode;
   \   000051   EA           MOV     A,R2
   \   000052   2408         ADD     A,#0x8
   \   000054   F5..         MOV     ?V0 + 2,A
   \   000056   EB           MOV     A,R3
   \   000057   3400         ADDC    A,#0x0
   \   000059   F5..         MOV     ?V0 + 3,A
   \   00005B   8882         MOV     DPL,R0
   \   00005D   8983         MOV     DPH,R1
   \   00005F   E0           MOVX    A,@DPTR
   \   000060   85..82       MOV     DPL,?V0 + 2
   \   000063   85..83       MOV     DPH,?V0 + 3
   \   000066   F0           MOVX    @DPTR,A
    329          
    330            // set DstAddr of MCPS-DATA Request to DstAddr of INTERP-Data Request
    331            if ( req->dstAddr.addrMode == AddrBroadcast )
   \   000067   8882         MOV     DPL,R0
   \   000069   8983         MOV     DPH,R1
   \   00006B   E0           MOVX    A,@DPTR
   \   00006C   F5..         MOV     ?V0 + 4,A
   \   00006E   740F         MOV     A,#0xf
   \   000070   65..         XRL     A,?V0 + 4
   \   000072   7013         JNZ     ??StubAPS_BuildFrameControl_3
    332            {
    333              *frmCtrl |= APS_FC_DM_BROADCAST;
   \   000074   8E82         MOV     DPL,R6
   \   000076   8F83         MOV     DPH,R7
   \   000078   E0           MOVX    A,@DPTR
   \   000079   D2E3         SETB    0xE0 /* A   */.3
   \   00007B   12....       LCALL   ?Subroutine3 & 0xFFFF
    334              
    335              // set DstAddrMode of MCPS-DATA Request to short address
    336              dstAddr->addrMode = Addr16Bit;
    337              dstAddr->addr.shortAddr = req->dstAddr.addr.shortAddr;
    338            }
   \                     ??CrossCallReturnLabel_2:
   \   00007E   12....       LCALL   ?Subroutine8 & 0xFFFF
   \                     ??CrossCallReturnLabel_43:
   \   000081   8A82         MOV     DPL,R2
   \   000083   8B83         MOV     DPH,R3
   \   000085   8033         SJMP    ??StubAPS_BuildFrameControl_4
    339            else if ( req->dstAddr.addrMode == Addr16Bit )
   \                     ??StubAPS_BuildFrameControl_3:
   \   000087   7402         MOV     A,#0x2
   \   000089   65..         XRL     A,?V0 + 4
   \   00008B   60F1         JZ      ??CrossCallReturnLabel_2
    340            {
    341              *frmCtrl |= APS_FC_DM_UNICAST;
    342              dstAddr->addr.shortAddr = req->dstAddr.addr.shortAddr;
    343            }
    344            else if ( req->dstAddr.addrMode == Addr64Bit )
   \   00008D   7403         MOV     A,#0x3
   \   00008F   65..         XRL     A,?V0 + 4
   \   000091   7005         JNZ     ??StubAPS_BuildFrameControl_5
    345            {
    346              *frmCtrl |= APS_FC_DM_UNICAST;
    347              osal_cpyExtAddr( dstAddr->addr.extAddr, req->dstAddr.addr.extAddr );
   \   000093                ; Setup parameters for call to function sAddrExtCpy
   \   000093   12....       LCALL   ??sAddrExtCpy?relay
   \   000096   8027         SJMP    ??StubAPS_BuildFrameControl_6
    348            }
    349            else if ( req->dstAddr.addrMode == AddrGroup )
   \                     ??StubAPS_BuildFrameControl_5:
   \   000098   7401         MOV     A,#0x1
   \   00009A   65..         XRL     A,?V0 + 4
   \   00009C   7021         JNZ     ??StubAPS_BuildFrameControl_6
    350            {
    351              *frmCtrl |= APS_FC_DM_GROUP;
   \   00009E   8E82         MOV     DPL,R6
   \   0000A0   8F83         MOV     DPH,R7
   \   0000A2   E0           MOVX    A,@DPTR
   \   0000A3   440C         ORL     A,#0xc
   \   0000A5   12....       LCALL   ?Subroutine3 & 0xFFFF
    352              
    353              // set DstAddrMode of MCPS-DATA Request to short address
    354              dstAddr->addrMode = Addr16Bit;
    355              
    356              // set DstAddr of MCPS-DATA Request to 0xFFFF
    357              dstAddr->addr.shortAddr = NWK_BROADCAST_SHORTADDR_DEVALL;
   \                     ??CrossCallReturnLabel_3:
   \   0000A8   8A82         MOV     DPL,R2
   \   0000AA   8B83         MOV     DPH,R3
   \   0000AC   74FF         MOV     A,#-0x1
   \   0000AE   F0           MOVX    @DPTR,A
   \   0000AF   A3           INC     DPTR
   \   0000B0   F0           MOVX    @DPTR,A
    358              
    359              // set Group ID to DstAddr of INTERP-Data Request
    360              *groupID = req->dstAddr.addr.shortAddr;
   \   0000B1   12....       LCALL   ?Subroutine8 & 0xFFFF
    361            }
   \                     ??CrossCallReturnLabel_44:
   \   0000B4   85..82       MOV     DPL,?V0 + 0
   \   0000B7   85..83       MOV     DPH,?V0 + 1
   \                     ??StubAPS_BuildFrameControl_4:
   \   0000BA   E8           MOV     A,R0
   \   0000BB   F0           MOVX    @DPTR,A
   \   0000BC   A3           INC     DPTR
   \   0000BD   E9           MOV     A,R1
   \   0000BE   F0           MOVX    @DPTR,A
    362            
    363            return ( ZSuccess );
   \                     ??StubAPS_BuildFrameControl_6:
   \   0000BF   7900         MOV     R1,#0x0
   \                     ??StubAPS_BuildFrameControl_2:
   \   0000C1   7F05         MOV     R7,#0x5
   \   0000C3   02....       LJMP    ?BANKED_LEAVE_XDATA
    364            
    365          } /* StubAPS_BuildFrameControl */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   F0           MOVX    @DPTR,A
   \   000001   7402         MOV     A,#0x2
   \   000003   85..82       MOV     DPL,?V0 + 2
   \   000006   85..83       MOV     DPH,?V0 + 3
   \   000009   F0           MOVX    @DPTR,A
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine18_0:
   \   000000   3400         ADDC    A,#0x0
   \   000002   F583         MOV     DPH,A
   \   000004   E0           MOVX    A,@DPTR
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine8:
   \   000000   8C82         MOV     DPL,R4
   \   000002   8D83         MOV     DPH,R5
   \   000004                REQUIRE ??Subroutine22_0
   \   000004                ; // Fall through to label ??Subroutine22_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine7:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   A3           INC     DPTR
   \   000003   E0           MOVX    A,@DPTR
   \   000004   F9           MOV     R1,A
   \   000005   88..         MOV     ?V0 + 0,R0
   \   000007   89..         MOV     ?V0 + 1,R1
   \   000009   22           RET
    366          
    367          /******************************************************************************
    368           * @fn          StubNWK_BuildMsg
    369           *
    370           * @brief       This function builds a Stub NWK frame.
    371           *
    372           * @param       nwkHdr - stub NWK header
    373           *
    374           * @return      none
    375           */
    376          static void StubNWK_BuildMsg( uint8 *nwkHdr )
    377          {
    378            uint16 frmCtrl = 0;
    379            uint8  protoVer = NLME_GetProtocolVersion();
    380          
    381            // frame type
    382            frmCtrl |= (STUB_NWK_FRAME_TYPE << NWK_FC_FRAME_TYPE);
    383          
    384            // protocol version
    385            frmCtrl |= (protoVer << NWK_FC_PROT_VERSION);
    386            
    387            // set Stub NWK header
    388            *nwkHdr++ = LO_UINT16( frmCtrl );
    389            *nwkHdr++ = HI_UINT16( frmCtrl );
    390            
    391          } /* StubNWK_BuildMsg */
    392          
    393          /******************************************************************************
    394           * @fn          StubAPS_BuildMsg
    395           *
    396           * @brief       This function builds a Stub APS frame.
    397           *
    398           * @param       apsHdr - stub APS header
    399           * @param       frmCtrl - stub APS frame control
    400           * @param       groupID - group id
    401           * @param       req - APSDE_DataReq_t
    402           *
    403           * @return      none
    404           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    405          static void StubAPS_BuildMsg( uint8 *apsHdr, uint8 frmCtrl, uint16 groupID, APSDE_DataReq_t *req )
   \                     StubAPS_BuildMsg:
    406          {
   \   000000   74F5         MOV     A,#-0xb
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 11
   \   000005                ; Auto size: 0
   \   000005   740B         MOV     A,#0xb
   \   000007   12....       LCALL   ?XSTACK_DISP0_8
   \   00000A   E0           MOVX    A,@DPTR
   \   00000B   FE           MOV     R6,A
   \   00000C   A3           INC     DPTR
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   FF           MOV     R7,A
    407            // add frame type
    408            *apsHdr++ = frmCtrl;
   \   00000F   E9           MOV     A,R1
   \   000010   8A82         MOV     DPL,R2
   \   000012   8B83         MOV     DPH,R3
   \   000014   F0           MOVX    @DPTR,A
   \   000015   A3           INC     DPTR
   \   000016   AA82         MOV     R2,DPL
   \   000018   AB83         MOV     R3,DPH
    409              
    410            // add Group ID
    411            if ( ( frmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_GROUP )
   \   00001A   740C         MOV     A,#0xc
   \   00001C   59           ANL     A,R1
   \   00001D   640C         XRL     A,#0xc
   \   00001F   700A         JNZ     ??StubAPS_BuildMsg_0
    412            {
    413              *apsHdr++ = LO_UINT16( groupID );
   \   000021   EC           MOV     A,R4
   \   000022   F0           MOVX    @DPTR,A
   \   000023   A3           INC     DPTR
    414              *apsHdr++ = HI_UINT16( groupID );
   \   000024   ED           MOV     A,R5
   \   000025   F0           MOVX    @DPTR,A
   \   000026   A3           INC     DPTR
   \   000027   0A           INC     R2
   \   000028   0A           INC     R2
   \   000029   AB83         MOV     R3,DPH
    415            }
    416          
    417            // add clusterID
    418            *apsHdr++ = LO_UINT16( req->clusterID );
   \                     ??StubAPS_BuildMsg_0:
   \   00002B   EE           MOV     A,R6
   \   00002C   240D         ADD     A,#0xd
   \   00002E   F8           MOV     R0,A
   \   00002F   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_32:
   \   000032   A3           INC     DPTR
   \   000033   AA82         MOV     R2,DPL
   \   000035   12....       LCALL   ?Subroutine5 & 0xFFFF
    419            *apsHdr++ = HI_UINT16( req->clusterID );
    420            
    421            // add profile ID
    422            *apsHdr++ = LO_UINT16( req->profileID );
   \                     ??CrossCallReturnLabel_7:
   \   000038   240F         ADD     A,#0xf
   \   00003A   08           INC     R0
   \   00003B   08           INC     R0
   \   00003C   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_33:
   \   00003F   A3           INC     DPTR
   \   000040   0A           INC     R2
   \   000041   12....       LCALL   ?Subroutine5 & 0xFFFF
    423            *apsHdr++ = HI_UINT16( req->profileID );
    424              
    425            // copy ASDU data into frame
    426            osal_memcpy ( apsHdr, req->asdu, req->asduLen );
   \                     ??CrossCallReturnLabel_8:
   \   000044   2413         ADD     A,#0x13
   \   000046   F582         MOV     DPL,A
   \   000048   EF           MOV     A,R7
   \   000049   12....       LCALL   ?Subroutine10 & 0xFFFF
   \                     ??CrossCallReturnLabel_14:
   \   00004C   75..00       MOV     ?V0 + 2,#0x0
   \   00004F   78..         MOV     R0,#?V0 + 0
   \   000051   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000054   EE           MOV     A,R6
   \   000055   2411         ADD     A,#0x11
   \   000057   12....       LCALL   ?Subroutine11 & 0xFFFF
   \                     ??CrossCallReturnLabel_27:
   \   00005A   FC           MOV     R4,A
   \   00005B   A3           INC     DPTR
   \   00005C   E0           MOVX    A,@DPTR
   \   00005D   FD           MOV     R5,A
   \   00005E   12....       LCALL   ??osal_memcpy?relay
   \   000061   7403         MOV     A,#0x3
   \   000063                REQUIRE ?Subroutine15
   \   000063                ; // Fall through to label ?Subroutine15
    427            
    428          } /* StubAPS_BuildMsg */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine15:
   \   000000   12....       LCALL   ?DEALLOC_XSTACK8
   \   000003   7F03         MOV     R7,#0x3
   \   000005   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine11:
   \   000000   F582         MOV     DPL,A
   \   000002   EF           MOV     A,R7
   \   000003                REQUIRE ??Subroutine18_0
   \   000003                ; // Fall through to label ??Subroutine18_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine6:
   \   000000   EF           MOV     A,R7
   \   000001   3400         ADDC    A,#0x0
   \   000003   F9           MOV     R1,A
   \   000004   8882         MOV     DPL,R0
   \   000006   8983         MOV     DPH,R1
   \   000008                REQUIRE ??Subroutine19_0
   \   000008                ; // Fall through to label ??Subroutine19_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   AB83         MOV     R3,DPH
   \   000002   8882         MOV     DPL,R0
   \   000004   8983         MOV     DPH,R1
   \   000006   A3           INC     DPTR
   \   000007   E0           MOVX    A,@DPTR
   \   000008   8A82         MOV     DPL,R2
   \   00000A   8B83         MOV     DPH,R3
   \   00000C   F0           MOVX    @DPTR,A
   \   00000D   A3           INC     DPTR
   \   00000E   0A           INC     R2
   \   00000F   AB83         MOV     R3,DPH
   \   000011                ; Setup parameters for call to function osal_memcpy
   \   000011   EE           MOV     A,R6
   \   000012   22           RET
    429          
    430          /******************************************************************************
    431           * @fn          StubAPS_setNewChannel
    432           *
    433           * @brief       This function changes the device's channel.
    434           *
    435           * @param       none
    436           *
    437           * @return      ZStatus_t
    438           */ 

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    439          static ZStatus_t StubAPS_SetNewChannel( uint8 channel )
   \                     StubAPS_SetNewChannel:
    440          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 2
   \   000004   74FE         MOV     A,#-0x2
   \   000006   12....       LCALL   ?ALLOC_XSTACK8
   \   000009   7401         MOV     A,#0x1
   \   00000B   12....       LCALL   ?XSTACK_DISP0_8
   \   00000E   E9           MOV     A,R1
   \   00000F   F0           MOVX    @DPTR,A
    441            uint8 rxOnIdle;
    442            
    443            // make sure MAC has nothing to transmit
    444            if ( ( nwkDB_CountTypes( NWK_DATABUF_SENT ) == 0 ) && ZMacStateIdle() )
   \   000010                ; Setup parameters for call to function nwkDB_CountTypes
   \   000010   7902         MOV     R1,#0x2
   \   000012   12....       LCALL   ??nwkDB_CountTypes?relay
   \   000015   E9           MOV     A,R1
   \   000016   7021         JNZ     ??StubAPS_SetNewChannel_0
   \   000018                ; Setup parameters for call to function ZMacStateIdle
   \   000018   12....       LCALL   ??ZMacStateIdle?relay
   \   00001B   E9           MOV     A,R1
   \   00001C   601B         JZ      ??StubAPS_SetNewChannel_0
    445            {
    446              // set the new channel
    447              ZMacSetReq( ZMacChannel, &channel );
   \   00001E                ; Setup parameters for call to function ZMacSetReq
   \   00001E   7401         MOV     A,#0x1
   \   000020   12....       LCALL   ?XSTACK_DISP0_8
   \   000023   AA82         MOV     R2,DPL
   \   000025   AB83         MOV     R3,DPH
   \   000027   79E1         MOV     R1,#-0x1f
   \   000029   12....       LCALL   ??ZMacSetReq?relay
    448          
    449              // turn MAC receiver back on
    450              rxOnIdle = true;
   \   00002C   7401         MOV     A,#0x1
   \   00002E   12....       LCALL   ??Subroutine20_0 & 0xFFFF
    451              ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    452            
    453              channelChangeInProgress = FALSE;
   \                     ??CrossCallReturnLabel_36:
   \   000031   E4           CLR     A
   \   000032   90....       MOV     DPTR,#channelChangeInProgress
   \   000035   F0           MOVX    @DPTR,A
    454              
    455              return ( ZSuccess );
   \   000036   F9           MOV     R1,A
   \   000037   8002         SJMP    ??StubAPS_SetNewChannel_1
    456            }
    457            
    458            return ( ZFailure );
   \                     ??StubAPS_SetNewChannel_0:
   \   000039   7901         MOV     R1,#0x1
   \                     ??StubAPS_SetNewChannel_1:
   \   00003B   02....       LJMP    ?Subroutine14 & 0xFFFF
    459            
    460          } /* StubAPS_setNewChannel */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine20_0:
   \   000000   12....       LCALL   ?Subroutine13 & 0xFFFF
   \                     ??CrossCallReturnLabel_37:
   \   000003   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine14:
   \   000000   7402         MOV     A,#0x2
   \   000002   12....       LCALL   ?DEALLOC_XSTACK8
   \   000005                REQUIRE ??Subroutine21_0
   \   000005                ; // Fall through to label ??Subroutine21_0
    461          
    462          
    463          /******************************************************************************
    464           * @fn          StubAPS_NotifyApp
    465           *
    466           * @brief       This function sends an OSAL message to the Application task.
    467           *
    468           * @param       status - command status
    469           *
    470           * @return      none
    471           */
    472          static void StubAPS_NotifyApp( uint8 status )
    473          {
    474            osal_event_hdr_t *msgPtr;
    475            
    476            // Notify the application task
    477            msgPtr = (osal_event_hdr_t *)osal_msg_allocate( sizeof(osal_event_hdr_t) );
    478            if ( msgPtr )
    479            {
    480              msgPtr->event = SAPS_CHANNEL_CHANGE;
    481              msgPtr->status = status;
    482              
    483              osal_msg_send( appTaskID, (uint8 *)msgPtr );
    484            }
    485            
    486          } /* StubAPS_NotifyApp */
    487          
    488          /******************************************************************************
    489           *
    490           *  External APIs provided to the Application.
    491           */
    492          
    493          /******************************************************************************
    494           * @fn          StubAPS_SetInterPanChannel
    495           *
    496           * @brief       This function changes the device's channel for inter-PAN communication.
    497           *
    498           * @param       channel - new channel
    499           *
    500           * @return      ZStatus_t
    501           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    502          ZStatus_t StubAPS_SetInterPanChannel( uint8 channel )
   \                     StubAPS_SetInterPanChannel:
    503          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 2
   \   000005   74FE         MOV     A,#-0x2
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   E9           MOV     A,R1
   \   00000B   FE           MOV     R6,A
    504            uint8 currChannel;
    505            uint8 rxOnIdle;
    506            
    507            if ( channelChangeInProgress )
   \   00000C   90....       MOV     DPTR,#channelChangeInProgress
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   6004         JZ      ??StubAPS_SetInterPanChannel_0
    508              return ( ZFailure );
   \   000012   7901         MOV     R1,#0x1
   \   000014   8047         SJMP    ??StubAPS_SetInterPanChannel_1
    509          
    510            ZMacGetReq( ZMacChannel, &currChannel );
   \                     ??StubAPS_SetInterPanChannel_0:
   \   000016                ; Setup parameters for call to function ZMacGetReq
   \   000016   7401         MOV     A,#0x1
   \   000018   12....       LCALL   ?XSTACK_DISP0_8
   \   00001B   AA82         MOV     R2,DPL
   \   00001D   AB83         MOV     R3,DPH
   \   00001F   79E1         MOV     R1,#-0x1f
   \   000021   12....       LCALL   ??ZMacGetReq?relay
    511            if ( currChannel == channel )
   \   000024   7401         MOV     A,#0x1
   \   000026   12....       LCALL   ?XSTACK_DISP0_8
   \   000029   E0           MOVX    A,@DPTR
   \   00002A   6E           XRL     A,R6
   \   00002B   7004         JNZ     ??StubAPS_SetInterPanChannel_2
    512            {
    513              // inter PANs communication within the same channel
    514              return ( ZSuccess );
   \                     ??StubAPS_SetInterPanChannel_3:
   \   00002D   7900         MOV     R1,#0x0
   \   00002F   802C         SJMP    ??StubAPS_SetInterPanChannel_1
    515            }
    516            
    517            // go into channel transition state
    518            channelChangeInProgress = TRUE;
   \                     ??StubAPS_SetInterPanChannel_2:
   \   000031   7401         MOV     A,#0x1
   \   000033   90....       MOV     DPTR,#channelChangeInProgress
   \   000036   F0           MOVX    @DPTR,A
    519            
    520            // set NWK task to idle
    521            nwk_setStateIdle( TRUE );
   \   000037                ; Setup parameters for call to function nwk_setStateIdle
   \   000037   F9           MOV     R1,A
   \   000038   12....       LCALL   ??nwk_setStateIdle?relay
    522            
    523            // turn MAC receiver off
    524            rxOnIdle = false;
   \   00003B   12....       LCALL   ?Subroutine2 & 0xFFFF
    525            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    526          
    527            // try to change to the new channel
    528            if ( StubAPS_SetNewChannel( channel ) == ZSuccess )
   \                     ??CrossCallReturnLabel_34:
   \   00003E                ; Setup parameters for call to function StubAPS_SetNewChannel
   \   00003E   EE           MOV     A,R6
   \   00003F   F9           MOV     R1,A
   \   000040   12....       LCALL   ??StubAPS_SetNewChannel?relay
   \   000043   E9           MOV     A,R1
   \   000044   60E7         JZ      ??StubAPS_SetInterPanChannel_3
    529              return ( ZSuccess );
    530              
    531            // save the new channel for retry
    532            newChannel = channel;
   \   000046   EE           MOV     A,R6
   \   000047   90....       MOV     DPTR,#newChannel
   \   00004A   F0           MOVX    @DPTR,A
    533            
    534            // ask StubAPS task to retry it later
    535            osal_start_timerEx( StubAPS_TaskID, CHANNEL_CHANGE_EVT, CHANNEL_CHANGE_RETRY_TIMEOUT );
   \   00004B                ; Setup parameters for call to function osal_start_timerEx
   \   00004B   7C64         MOV     R4,#0x64
   \   00004D   7D00         MOV     R5,#0x0
   \   00004F   7A01         MOV     R2,#0x1
   \   000051   7B00         MOV     R3,#0x0
   \   000053   90....       MOV     DPTR,#StubAPS_TaskID
   \   000056   E0           MOVX    A,@DPTR
   \   000057   F9           MOV     R1,A
   \   000058   12....       LCALL   ??osal_start_timerEx?relay
    536              
    537            return ( ZApsNotAllowed );
   \   00005B   79BA         MOV     R1,#-0x46
   \                     ??StubAPS_SetInterPanChannel_1:
   \   00005D   7402         MOV     A,#0x2
   \   00005F                REQUIRE ?Subroutine16
   \   00005F                ; // Fall through to label ?Subroutine16
    538            
    539          } /* StubAPS_SetInterPanChannel */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine16:
   \   000000   12....       LCALL   ?DEALLOC_XSTACK8
   \   000003   7F01         MOV     R7,#0x1
   \   000005   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   E4           CLR     A
   \   000001                REQUIRE ??Subroutine20_0
   \   000001                ; // Fall through to label ??Subroutine20_0
    540          
    541          /******************************************************************************
    542           * @fn          StubAPS_SetIntraPanChannel
    543           *
    544           * @brief       This function sets the device's channel back to the NIB channel.
    545           *
    546           * @param       none
    547           *
    548           * @return      ZStatus_t
    549           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    550          ZStatus_t StubAPS_SetIntraPanChannel( void )
   \                     StubAPS_SetIntraPanChannel:
    551          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 2
   \   000004   74FE         MOV     A,#-0x2
   \   000006   12....       LCALL   ?ALLOC_XSTACK8
    552            uint8 currChannel;
    553            uint8 rxOnIdle;
    554            
    555            if ( channelChangeInProgress )
   \   000009   90....       MOV     DPTR,#channelChangeInProgress
   \   00000C   E0           MOVX    A,@DPTR
   \   00000D   6004         JZ      ??StubAPS_SetIntraPanChannel_0
    556              return ( ZFailure );
   \   00000F   7901         MOV     R1,#0x1
   \   000011   8036         SJMP    ??StubAPS_SetIntraPanChannel_1
    557            
    558            ZMacGetReq( ZMacChannel, &currChannel );
   \                     ??StubAPS_SetIntraPanChannel_0:
   \   000013                ; Setup parameters for call to function ZMacGetReq
   \   000013   7401         MOV     A,#0x1
   \   000015   12....       LCALL   ?XSTACK_DISP0_8
   \   000018   AA82         MOV     R2,DPL
   \   00001A   AB83         MOV     R3,DPH
   \   00001C   79E1         MOV     R1,#-0x1f
   \   00001E   12....       LCALL   ??ZMacGetReq?relay
    559            if ( currChannel == _NIB.nwkLogicalChannel )
   \   000021   7401         MOV     A,#0x1
   \   000023   12....       LCALL   ?XSTACK_DISP0_8
   \   000026   E0           MOVX    A,@DPTR
   \   000027   FA           MOV     R2,A
   \   000028   90....       MOV     DPTR,#(_NIB + 22)
   \   00002B   E0           MOVX    A,@DPTR
   \   00002C   6A           XRL     A,R2
   \   00002D   7004         JNZ     ??StubAPS_SetIntraPanChannel_2
    560              return ( ZSuccess );
   \   00002F   7900         MOV     R1,#0x0
   \   000031   8016         SJMP    ??StubAPS_SetIntraPanChannel_1
    561            
    562            channelChangeInProgress = TRUE;
   \                     ??StubAPS_SetIntraPanChannel_2:
   \   000033   7401         MOV     A,#0x1
   \   000035   90....       MOV     DPTR,#channelChangeInProgress
   \   000038   F0           MOVX    @DPTR,A
    563            
    564            // turn MAC receiver off
    565            rxOnIdle = false;
   \   000039   12....       LCALL   ?Subroutine2 & 0xFFFF
    566            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    567            
    568            // set the NIB channel
    569            ZMacSetReq( ZMacChannel, &(_NIB.nwkLogicalChannel) );
   \                     ??CrossCallReturnLabel_35:
   \   00003C                ; Setup parameters for call to function ZMacSetReq
   \   00003C   7A..         MOV     R2,#((_NIB + 22) & 0xff)
   \   00003E   7B..         MOV     R3,#(((_NIB + 22) >> 8) & 0xff)
   \   000040   79E1         MOV     R1,#-0x1f
   \   000042   12....       LCALL   ??ZMacSetReq?relay
    570            
    571            // turn MAC receiver back on
    572            rxOnIdle = true;
   \   000045   12....       LCALL   ?Subroutine1 & 0xFFFF
    573            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    574             
    575            // set NWK task to run
    576            nwk_setStateIdle( FALSE );
    577            
    578            channelChangeInProgress = FALSE;
    579            
    580            return ( ZSuccess );
   \                     ??CrossCallReturnLabel_1:
   \   000048   F9           MOV     R1,A
   \                     ??StubAPS_SetIntraPanChannel_1:
   \   000049   80..         SJMP    ?Subroutine14
    581            
    582          } /* StubAPS_SetIntraPanChannel */
    583          
    584          /******************************************************************************
    585           * @fn          StubAPS_InterPan
    586           *
    587           * @brief       This function checks to see if a PAN is an Inter-PAN.
    588           *
    589           * @param       panId - PAN ID
    590           * @param       endPoint - endpoint
    591           *
    592           * @return      TRUE if PAN is Inter-PAN, FALSE otherwise
    593           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    594          uint8 StubAPS_InterPan( uint16 panId, uint8 endPoint )
   \                     StubAPS_InterPan:
    595          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV     A,#-0x1
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
   \   00000E   89..         MOV     ?V0 + 0,R1
    596            uint8 currChannel;
    597            
    598            if ( panId != 0 )
   \   000010   EE           MOV     A,R6
   \   000011   7001         JNZ     ??StubAPS_InterPan_0
   \   000013   EF           MOV     A,R7
   \                     ??StubAPS_InterPan_0:
   \   000014   6034         JZ      ??StubAPS_InterPan_1
    599            {
    600              ZMacGetReq( ZMacChannel, &currChannel );
   \   000016                ; Setup parameters for call to function ZMacGetReq
   \   000016   85..82       MOV     DPL,?XSP + 0
   \   000019   85..83       MOV     DPH,?XSP + 1
   \   00001C   AA82         MOV     R2,DPL
   \   00001E   AB83         MOV     R3,DPH
   \   000020   79E1         MOV     R1,#-0x1f
   \   000022   12....       LCALL   ??ZMacGetReq?relay
    601              if ( currChannel != _NIB.nwkLogicalChannel )
   \   000025   85..82       MOV     DPL,?XSP + 0
   \   000028   85..83       MOV     DPH,?XSP + 1
   \   00002B   E0           MOVX    A,@DPTR
   \   00002C   FA           MOV     R2,A
   \   00002D   90....       MOV     DPTR,#(_NIB + 22)
   \   000030   E0           MOVX    A,@DPTR
   \   000031   6A           XRL     A,R2
   \   000032   6004         JZ      ??StubAPS_InterPan_2
    602              {
    603                // different Channels
    604                return ( TRUE );
   \                     ??StubAPS_InterPan_3:
   \   000034   7901         MOV     R1,#0x1
   \   000036   8014         SJMP    ??StubAPS_InterPan_4
    605              }
    606            
    607              // same Channels
    608              if ( panId != _NIB.nwkPanId )
   \                     ??StubAPS_InterPan_2:
   \   000038   90....       MOV     DPTR,#(_NIB + 33)
   \   00003B   E0           MOVX    A,@DPTR
   \   00003C   6E           XRL     A,R6
   \   00003D   7003         JNZ     ??StubAPS_InterPan_5
   \   00003F   A3           INC     DPTR
   \   000040   E0           MOVX    A,@DPTR
   \   000041   6F           XRL     A,R7
   \                     ??StubAPS_InterPan_5:
   \   000042   70F0         JNZ     ??StubAPS_InterPan_3
    609              {
    610                // different PAN IDs
    611                return ( TRUE );
    612              }
    613            
    614              // same Channels and same PAN IDs
    615              if ( endPoint == STUBAPS_INTER_PAN_EP )
   \   000044   74FE         MOV     A,#-0x2
   \   000046   65..         XRL     A,?V0 + 0
   \   000048   60EA         JZ      ??StubAPS_InterPan_3
    616              {
    617                // Inter-PAN endpoint
    618                return ( TRUE );
    619              }
    620            }
    621            
    622            return ( FALSE );
   \                     ??StubAPS_InterPan_1:
   \   00004A   7900         MOV     R1,#0x0
   \                     ??StubAPS_InterPan_4:
   \   00004C   7401         MOV     A,#0x1
   \   00004E   02....       LJMP    ?Subroutine16 & 0xFFFF
    623            
    624          } /* StubAPS_InterPan */
    625          
    626          /******************************************************************************
    627           * @fn          StubAPS_RegisterApp
    628           *
    629           * @brief       This function registers the Application with the Stub APS layer.
    630           *
    631           *              NOTE: Since Stub APS messages don't include the application
    632           *                    endpoint, the application has to register its endpoint
    633           *                    with Stub APS.
    634           *
    635           * @param       epDesc - application's endpoint descriptor
    636           *
    637           * @return      none
    638           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    639          void StubAPS_RegisterApp( endPointDesc_t *epDesc )
   \                     StubAPS_RegisterApp:
    640          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    641            appTaskID = *epDesc->task_id;
   \   000004   8A82         MOV     DPL,R2
   \   000006   8B83         MOV     DPH,R3
   \   000008   12....       LCALL   ?Subroutine9 & 0xFFFF
   \                     ??CrossCallReturnLabel_11:
   \   00000B   E0           MOVX    A,@DPTR
   \   00000C   90....       MOV     DPTR,#appTaskID
   \   00000F   F0           MOVX    @DPTR,A
    642            appEndPoint = epDesc->endPoint;
   \   000010   8A82         MOV     DPL,R2
   \   000012   8B83         MOV     DPH,R3
   \   000014   E0           MOVX    A,@DPTR
   \   000015   90....       MOV     DPTR,#appEndPoint
   \   000018   F0           MOVX    @DPTR,A
    643            
    644          } /* StubAPS_RegisterApp */
   \   000019   80..         SJMP    ??Subroutine21_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine9:
   \   000000   A3           INC     DPTR
   \   000001   E0           MOVX    A,@DPTR
   \   000002   F8           MOV     R0,A
   \   000003   A3           INC     DPTR
   \   000004   E0           MOVX    A,@DPTR
   \   000005   F583         MOV     DPH,A
   \   000007   8882         MOV     DPL,R0
   \   000009   22           RET
    645          
    646          /******************************************************************************
    647           * @fn          StubAPS_ZMacCallback
    648           *
    649           * @brief       This function accepts an inter-PAN message from ZMac.
    650           *
    651           * @param       msgPtr - received message
    652           *
    653           * @return      TRUE if message is processed. FALSE otherwise.
    654           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    655          uint8 StubAPS_ZMacCallback( uint8 *msgPtr )
   \                     StubAPS_ZMacCallback:
    656          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    657            uint16 nwk_fc;
    658            uint8  aps_fc;
    659            uint8  frameType;
    660            uint8 *buf = NULL;
    661            uint8  event = ((osal_event_hdr_t *)msgPtr)->event;
   \   000004   8A82         MOV     DPL,R2
   \   000006   8B83         MOV     DPH,R3
   \   000008   E0           MOVX    A,@DPTR
   \   000009   FC           MOV     R4,A
    662          
    663            if ( event == MAC_MCPS_DATA_IND )
   \   00000A   740D         MOV     A,#0xd
   \   00000C   6C           XRL     A,R4
   \   00000D   600A         JZ      ??CrossCallReturnLabel_12
    664            {
    665              buf = ((macMcpsDataInd_t *)msgPtr)->msdu.p;
    666            }
    667            else if ( event == MAC_MCPS_DATA_CNF )
   \   00000F   740C         MOV     A,#0xc
   \   000011   6C           XRL     A,R4
   \   000012   701D         JNZ     ??StubAPS_ZMacCallback_0
    668            {
    669              buf = ((macMcpsDataCnf_t *)msgPtr)->pDataReq->msdu.p;
   \   000014   A3           INC     DPTR
   \   000015   A3           INC     DPTR
   \   000016   12....       LCALL   ?Subroutine9 & 0xFFFF
    670            }
   \                     ??CrossCallReturnLabel_12:
   \   000019   A3           INC     DPTR
   \   00001A   A3           INC     DPTR
   \   00001B   12....       LCALL   ??Subroutine22_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_40:
   \   00001E   8882         MOV     DPL,R0
   \   000020   8983         MOV     DPH,R1
    671            
    672            if ( buf )
   \   000022   E582         MOV     A,DPL
   \   000024   7002         JNZ     ??StubAPS_ZMacCallback_1
   \   000026   E583         MOV     A,DPH
   \                     ??StubAPS_ZMacCallback_1:
   \   000028   6007         JZ      ??StubAPS_ZMacCallback_0
    673            {
    674              // get the NWK frame control
    675              nwk_fc = BUILD_UINT16( buf[NWK_HDR_FRAME_CTRL_LSB], buf[NWK_HDR_FRAME_CTRL_MSB] );
    676            
    677              // frame type
    678              frameType = (uint8)((nwk_fc >> NWK_FC_FRAME_TYPE) & NWK_FC_FRAME_TYPE_MASK);
    679            
    680              // check if incoming frame is of the right type
    681              if ( frameType != STUB_NWK_FRAME_TYPE )
   \   00002A   E0           MOVX    A,@DPTR
   \   00002B   5403         ANL     A,#0x3
   \   00002D   6403         XRL     A,#0x3
   \   00002F   6004         JZ      ??StubAPS_ZMacCallback_2
    682              {
    683                // message doesn't belong to Stub APS
    684                return ( FALSE );
   \                     ??StubAPS_ZMacCallback_0:
   \   000031   7900         MOV     R1,#0x0
   \   000033   8013         SJMP    ??StubAPS_ZMacCallback_3
    685              }
    686           
    687              // get the APS frame control
    688              aps_fc = buf[STUB_APS_HDR_FRAME_CTRL];
    689            
    690              // frame type
    691              frameType = aps_fc & APS_FRAME_TYPE_MASK;
    692              
    693              // check if incoming frame is of the right type
    694              if ( frameType != STUB_APS_FRAME )
   \                     ??StubAPS_ZMacCallback_2:
   \   000035   A3           INC     DPTR
   \   000036   A3           INC     DPTR
   \   000037   E0           MOVX    A,@DPTR
   \   000038   5403         ANL     A,#0x3
   \   00003A   6403         XRL     A,#0x3
   \   00003C   70F3         JNZ     ??StubAPS_ZMacCallback_0
    695              {
    696                // message doesn't belong to Stub APS
    697                return ( FALSE );
    698              }
    699              
    700              // message belongs to Stub APS
    701              osal_msg_send( StubAPS_TaskID, (uint8 *)msgPtr );
   \   00003E                ; Setup parameters for call to function osal_msg_send
   \   00003E   90....       MOV     DPTR,#StubAPS_TaskID
   \   000041   E0           MOVX    A,@DPTR
   \   000042   F9           MOV     R1,A
   \   000043   12....       LCALL   ??osal_msg_send?relay
    702           
    703              return ( TRUE );
   \   000046   7901         MOV     R1,#0x1
    704            }
   \                     ??StubAPS_ZMacCallback_3:
   \   000048   80..         SJMP    ??Subroutine21_0
    705            
    706            // message doesn't belong to Stub APS
    707            return ( FALSE );
    708              
    709          } /* StubAPS_ZMacCallback */
    710          
    711          /******************************************************************************
    712           *
    713           *  Stub APS Inter-PAN interface INTERP and its callbacks.
    714           */
    715          
    716          /******************************************************************************
    717           * @fn          INTERP_DataReq
    718           *
    719           * @brief       This function requests the transfer of data from the next
    720           *              higher layer to a single peer entity.
    721           *
    722           * @param       req - APSDE_DataReq_t
    723           *
    724           * @return      ZStatus_t
    725           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    726          ZStatus_t INTERP_DataReq( APSDE_DataReq_t *req )
   \                     INTERP_DataReq:
    727          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 33
   \   000005   74DF         MOV     A,#-0x21
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 4,R2
   \   00000C   8B..         MOV     ?V0 + 5,R3
    728            uint8 apsFrmCtrl;
    729            uint16 groupID = 0;
   \   00000E   7401         MOV     A,#0x1
   \   000010   12....       LCALL   ?XSTACK_DISP0_8
   \   000013   E4           CLR     A
   \   000014   F0           MOVX    @DPTR,A
   \   000015   A3           INC     DPTR
   \   000016   F0           MOVX    @DPTR,A
    730            uint8 *buf;
    731            uint8 hdrLen;
    732            ZMacDataReq_t dataReq;
    733            ZStatus_t status;
    734            
    735            if ( channelChangeInProgress || !StubAPS_InterPan( req->dstPanId, req->dstEP ) )
   \   000017   90....       MOV     DPTR,#channelChangeInProgress
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   702B         JNZ     ??INTERP_DataReq_0
   \   00001D   EA           MOV     A,R2
   \   00001E   240B         ADD     A,#0xb
   \   000020   F5..         MOV     ?V0 + 0,A
   \   000022   EB           MOV     A,R3
   \   000023   3400         ADDC    A,#0x0
   \   000025   F5..         MOV     ?V0 + 1,A
   \   000027                ; Setup parameters for call to function StubAPS_InterPan
   \   000027   8A82         MOV     DPL,R2
   \   000029   8B83         MOV     DPH,R3
   \   00002B   A3           INC     DPTR
   \   00002C   A3           INC     DPTR
   \   00002D   A3           INC     DPTR
   \   00002E   A3           INC     DPTR
   \   00002F   A3           INC     DPTR
   \   000030   A3           INC     DPTR
   \   000031   A3           INC     DPTR
   \   000032   A3           INC     DPTR
   \   000033   A3           INC     DPTR
   \   000034   A3           INC     DPTR
   \   000035   E0           MOVX    A,@DPTR
   \   000036   F9           MOV     R1,A
   \   000037   85..82       MOV     DPL,?V0 + 0
   \   00003A   85..83       MOV     DPH,?V0 + 1
   \   00003D   E0           MOVX    A,@DPTR
   \   00003E   FA           MOV     R2,A
   \   00003F   A3           INC     DPTR
   \   000040   E0           MOVX    A,@DPTR
   \   000041   FB           MOV     R3,A
   \   000042   12....       LCALL   ??StubAPS_InterPan?relay
   \   000045   E9           MOV     A,R1
   \   000046   700C         JNZ     ??INTERP_DataReq_1
    736              return ( ZFailure );
   \                     ??INTERP_DataReq_0:
   \   000048   7901         MOV     R1,#0x1
   \                     ??INTERP_DataReq_2:
   \   00004A   7421         MOV     A,#0x21
   \   00004C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00004F   7F08         MOV     R7,#0x8
   \   000051   02....       LJMP    ?BANKED_LEAVE_XDATA
    737            
    738            osal_memset( &dataReq, 0, sizeof( ZMacDataReq_t ) );
   \                     ??INTERP_DataReq_1:
   \   000054                ; Setup parameters for call to function osal_memset
   \   000054   7C1E         MOV     R4,#0x1e
   \   000056   7D00         MOV     R5,#0x0
   \   000058   7900         MOV     R1,#0x0
   \   00005A   7403         MOV     A,#0x3
   \   00005C   12....       LCALL   ?XSTACK_DISP0_8
   \   00005F   AA82         MOV     R2,DPL
   \   000061   AB83         MOV     R3,DPH
   \   000063   12....       LCALL   ??osal_memset?relay
    739            
    740            // Build Stub APS header
    741            status = StubAPS_BuildFrameControl( &apsFrmCtrl, &(dataReq.DstAddr), &groupID, req );
   \   000066                ; Setup parameters for call to function StubAPS_BuildFrameControl
   \   000066   78..         MOV     R0,#?V0 + 4
   \   000068   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00006B   7403         MOV     A,#0x3
   \   00006D   12....       LCALL   ?XSTACK_DISP0_8
   \   000070   8582..       MOV     ?V0 + 2,DPL
   \   000073   8583..       MOV     ?V0 + 3,DPH
   \   000076   78..         MOV     R0,#?V0 + 2
   \   000078   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00007B   7407         MOV     A,#0x7
   \   00007D   12....       LCALL   ?XSTACK_DISP0_8
   \   000080   AC82         MOV     R4,DPL
   \   000082   AD83         MOV     R5,DPH
   \   000084   7404         MOV     A,#0x4
   \   000086   12....       LCALL   ?XSTACK_DISP0_8
   \   000089   AA82         MOV     R2,DPL
   \   00008B   AB83         MOV     R3,DPH
   \   00008D   12....       LCALL   ??StubAPS_BuildFrameControl?relay
   \   000090   7404         MOV     A,#0x4
   \   000092   12....       LCALL   ?DEALLOC_XSTACK8
   \   000095   E9           MOV     A,R1
   \   000096   F5..         MOV     ?V0 + 2,A
    742            if ( status != ZSuccess )
   \   000098   6004         JZ      ??INTERP_DataReq_3
    743              return ( status );
   \                     ??INTERP_DataReq_4:
   \   00009A   A9..         MOV     R1,?V0 + 2
   \   00009C   80AC         SJMP    ??INTERP_DataReq_2
    744          
    745            // set default Stub APS header length
    746            hdrLen = APS_FRAME_CTRL_FIELD_LEN;
   \                     ??INTERP_DataReq_3:
   \   00009E   7A01         MOV     R2,#0x1
    747            
    748            // add group ID length
    749            if ( ( apsFrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_GROUP )
   \   0000A0   85..82       MOV     DPL,?XSP + 0
   \   0000A3   85..83       MOV     DPH,?XSP + 1
   \   0000A6   E0           MOVX    A,@DPTR
   \   0000A7   540C         ANL     A,#0xc
   \   0000A9   640C         XRL     A,#0xc
   \   0000AB   7002         JNZ     ??INTERP_DataReq_5
    750              hdrLen += APS_GROUP_ID_FIELD_LEN;
   \   0000AD   0A           INC     R2
   \   0000AE   0A           INC     R2
    751            
    752            // add cluster ID length
    753            hdrLen += APS_CLUSTERID_FIELD_LEN;
    754            
    755            // add profile ID length
    756            hdrLen += APS_PROFILEID_FIELD_LEN;
    757            
    758            // add default Stub NWK header length
    759            hdrLen += STUB_NWK_HDR_LEN;
    760            
    761            // calculate MSDU length
    762            dataReq.msduLength = hdrLen + req->asduLen;
   \                     ??INTERP_DataReq_5:
   \   0000AF   E5..         MOV     A,?V0 + 4
   \   0000B1   2411         ADD     A,#0x11
   \   0000B3   F582         MOV     DPL,A
   \   0000B5   E5..         MOV     A,?V0 + 5
   \   0000B7   12....       LCALL   ??Subroutine18_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_25:
   \   0000BA   2A           ADD     A,R2
   \   0000BB   2406         ADD     A,#0x6
   \   0000BD   FA           MOV     R2,A
   \   0000BE   741E         MOV     A,#0x1e
   \   0000C0   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C3   EA           MOV     A,R2
   \   0000C4   F0           MOVX    @DPTR,A
    763            
    764            // allocate buffer
    765            buf = osal_mem_alloc( dataReq.msduLength );
   \   0000C5                ; Setup parameters for call to function osal_mem_alloc
   \   0000C5   7B00         MOV     R3,#0x0
   \   0000C7   12....       LCALL   ??osal_mem_alloc?relay
   \   0000CA   8A..         MOV     ?V0 + 2,R2
   \   0000CC   8B..         MOV     ?V0 + 3,R3
   \   0000CE   AE..         MOV     R6,?V0 + 2
   \   0000D0   AF..         MOV     R7,?V0 + 3
    766            if ( buf != NULL )
   \   0000D2   EE           MOV     A,R6
   \   0000D3   7001         JNZ     ??INTERP_DataReq_6
   \   0000D5   EF           MOV     A,R7
   \                     ??INTERP_DataReq_6:
   \   0000D6   7003         JNZ     $+5
   \   0000D8   02....       LJMP    ??INTERP_DataReq_7 & 0xFFFF
    767            {
    768              dataReq.msdu = buf;
   \   0000DB   741F         MOV     A,#0x1f
   \   0000DD   12....       LCALL   ?XSTACK_DISP0_8
   \   0000E0   EE           MOV     A,R6
   \   0000E1   F0           MOVX    @DPTR,A
   \   0000E2   A3           INC     DPTR
   \   0000E3   EF           MOV     A,R7
   \   0000E4   F0           MOVX    @DPTR,A
    769              
    770              // Add Stub APS header and data
    771              StubAPS_BuildMsg( &buf[STUB_APS_HDR_FRAME_CTRL], apsFrmCtrl, groupID, req );
   \   0000E5                ; Setup parameters for call to function StubAPS_BuildMsg
   \   0000E5   78..         MOV     R0,#?V0 + 4
   \   0000E7   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000EA   7403         MOV     A,#0x3
   \   0000EC   12....       LCALL   ?XSTACK_DISP0_8
   \   0000EF   E0           MOVX    A,@DPTR
   \   0000F0   FC           MOV     R4,A
   \   0000F1   A3           INC     DPTR
   \   0000F2   E0           MOVX    A,@DPTR
   \   0000F3   FD           MOV     R5,A
   \   0000F4   7402         MOV     A,#0x2
   \   0000F6   12....       LCALL   ?XSTACK_DISP0_8
   \   0000F9   E0           MOVX    A,@DPTR
   \   0000FA   F9           MOV     R1,A
   \   0000FB   EE           MOV     A,R6
   \   0000FC   2402         ADD     A,#0x2
   \   0000FE   0A           INC     R2
   \   0000FF   0A           INC     R2
   \   000100   EF           MOV     A,R7
   \   000101   3400         ADDC    A,#0x0
   \   000103   FB           MOV     R3,A
   \   000104   12....       LCALL   ??StubAPS_BuildMsg?relay
   \   000107   7402         MOV     A,#0x2
   \   000109   12....       LCALL   ?DEALLOC_XSTACK8
    772              
    773              // Add Stub NWK header
    774              StubNWK_BuildMsg( buf );  
   \   00010C                ; Setup parameters for call to function NLME_GetProtocolVersion
   \   00010C   12....       LCALL   ??NLME_GetProtocolVersion?relay
   \   00010F   E9           MOV     A,R1
   \   000110   F5..         MOV     ?V0 + 6,A
   \   000112   75..00       MOV     ?V0 + 7,#0x0
   \   000115   7402         MOV     A,#0x2
   \   000117   78..         MOV     R0,#?V0 + 6
   \   000119   12....       LCALL   ?S_SHL
   \   00011C   7403         MOV     A,#0x3
   \   00011E   45..         ORL     A,?V0 + 6
   \   000120   8E82         MOV     DPL,R6
   \   000122   8F83         MOV     DPH,R7
   \   000124   F0           MOVX    @DPTR,A
   \   000125   A3           INC     DPTR
   \   000126   E5..         MOV     A,?V0 + 7
   \   000128   F0           MOVX    @DPTR,A
    775          
    776              // Set ZMac data request
    777              dataReq.DstPANId = req->dstPanId;
   \   000129   85..82       MOV     DPL,?V0 + 0
   \   00012C   85..83       MOV     DPH,?V0 + 1
   \   00012F   12....       LCALL   ??Subroutine22_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_41:
   \   000132   740C         MOV     A,#0xc
   \   000134   12....       LCALL   ?XSTACK_DISP0_8
   \   000137   E8           MOV     A,R0
   \   000138   F0           MOVX    @DPTR,A
   \   000139   A3           INC     DPTR
   \   00013A   E9           MOV     A,R1
   \   00013B   F0           MOVX    @DPTR,A
    778              dataReq.SrcAddrMode = Addr64Bit; 
   \   00013C   740E         MOV     A,#0xe
   \   00013E   12....       LCALL   ?XSTACK_DISP0_8
   \   000141   7403         MOV     A,#0x3
   \   000143   F0           MOVX    @DPTR,A
    779              dataReq.Handle = req->transID;
   \   000144   E5..         MOV     A,?V0 + 4
   \   000146   2417         ADD     A,#0x17
   \   000148   F582         MOV     DPL,A
   \   00014A   E5..         MOV     A,?V0 + 5
   \   00014C   12....       LCALL   ??Subroutine18_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_26:
   \   00014F   C0E0         PUSH    A
   \   000151   740F         MOV     A,#0xf
   \   000153   12....       LCALL   ?XSTACK_DISP0_8
   \   000156   D0E0         POP     A
   \   000158   F0           MOVX    @DPTR,A
    780            
    781              if ( ( apsFrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_UNICAST )
   \   000159   85..82       MOV     DPL,?XSP + 0
   \   00015C   85..83       MOV     DPH,?XSP + 1
   \   00015F   E0           MOVX    A,@DPTR
   \   000160   540C         ANL     A,#0xc
   \   000162   7009         JNZ     ??INTERP_DataReq_8
    782                dataReq.TxOptions = NWK_TXOPTIONS_ACK;
   \   000164   7410         MOV     A,#0x10
   \   000166   12....       LCALL   ?XSTACK_DISP0_8
   \   000169   7401         MOV     A,#0x1
   \   00016B   8006         SJMP    ??INTERP_DataReq_9
    783              else
    784                dataReq.TxOptions = 0;
   \                     ??INTERP_DataReq_8:
   \   00016D   7410         MOV     A,#0x10
   \   00016F   12....       LCALL   ?XSTACK_DISP0_8
   \   000172   E4           CLR     A
   \                     ??INTERP_DataReq_9:
   \   000173   F0           MOVX    @DPTR,A
    785              
    786              // send the frame
    787              status = ZMacDataReq( &dataReq );
   \   000174                ; Setup parameters for call to function ZMacDataReq
   \   000174   7403         MOV     A,#0x3
   \   000176   12....       LCALL   ?XSTACK_DISP0_8
   \   000179   AA82         MOV     R2,DPL
   \   00017B   AB83         MOV     R3,DPH
   \   00017D   12....       LCALL   ??ZMacDataReq?relay
   \   000180   E9           MOV     A,R1
   \   000181   F5..         MOV     ?V0 + 2,A
    788              
    789              // free the frame
    790              osal_mem_free( buf );
   \   000183                ; Setup parameters for call to function osal_mem_free
   \   000183   EE           MOV     A,R6
   \   000184   FA           MOV     R2,A
   \   000185   EF           MOV     A,R7
   \   000186   FB           MOV     R3,A
   \   000187   12....       LCALL   ??osal_mem_free?relay
   \   00018A   02....       LJMP    ??INTERP_DataReq_4 & 0xFFFF
    791            }
    792            else
    793            {
    794              // flag a memory error
    795              status = ZMemError;
   \                     ??INTERP_DataReq_7:
   \   00018D   75..10       MOV     ?V0 + 2,#0x10
   \   000190   02....       LJMP    ??INTERP_DataReq_4 & 0xFFFF
    796            }
    797            
    798            return ( status );
    799            
    800          } /* INTERP_DataReq */
    801          
    802          /******************************************************************************
    803           * @fn          INTERP_DataReqMTU
    804           *
    805           * @brief       This function requests the MTU (Max Transport Unit) of the
    806           *              Inter-PAN Data Service.
    807           *
    808           * @param       none
    809           *
    810           * @return      uint8 - MTU
    811           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    812          uint8 INTERP_DataReqMTU( void )
   \                     INTERP_DataReqMTU:
    813          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    814            uint8 mtu;
    815            uint8 hdrLen;
    816            
    817            // Use maximum header size for Stub APS header
    818            hdrLen = APS_FRAME_CTRL_FIELD_LEN +
    819                     APS_GROUP_ID_FIELD_LEN   +
    820                     APS_CLUSTERID_FIELD_LEN  +
    821                     APS_PROFILEID_FIELD_LEN;
    822          
    823            mtu = MAC_A_MAX_FRAME_SIZE - STUB_NWK_HDR_LEN - hdrLen;
    824          
    825            return ( mtu );
   \   000000   795D         MOV     R1,#0x5d
   \   000002   02....       LJMP    ?BRET
    826          
    827          } /* INTERP_DataReqMTU */
    828          
    829          /****************************************************************************
    830           * @fn          INTERP_DataConfirm
    831           *
    832           * @brief       This function processes the data confirm from the MAC layer.
    833           *
    834           * @param       dataCnf - data confirm primitive
    835           *
    836           * @return      none
    837           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    838          void INTERP_DataConfirm( ZMacDataCnf_t *dataCnf )
   \                     INTERP_DataConfirm:
    839          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   \   000004   EA           MOV     A,R2
   \   000005   F8           MOV     R0,A
   \   000006   EB           MOV     A,R3
   \   000007   F9           MOV     R1,A
    840            afDataConfirm( appEndPoint, dataCnf->msduHandle, dataCnf->hdr.Status );
   \   000008                ; Setup parameters for call to function afDataConfirm
   \   000008   8882         MOV     DPL,R0
   \   00000A   8983         MOV     DPH,R1
   \   00000C   A3           INC     DPTR
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   FB           MOV     R3,A
   \   00000F   8882         MOV     DPL,R0
   \   000011   8983         MOV     DPH,R1
   \   000013   A3           INC     DPTR
   \   000014   A3           INC     DPTR
   \   000015   E0           MOVX    A,@DPTR
   \   000016   FA           MOV     R2,A
   \   000017   90....       MOV     DPTR,#appEndPoint
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   F9           MOV     R1,A
   \   00001C   12....       LCALL   ??afDataConfirm?relay
    841          
    842          } /* INTERP_DataConfirm */
   \   00001F   02....       LJMP    ??Subroutine21_0 & 0xFFFF
    843          
    844          /****************************************************************************
    845           * @fn          INTERP_DataIndication
    846           *
    847           * @brief       This function indicates the transfer of a data SPDU (MSDU)
    848           *              from the MAC layer to the local application layer entity.
    849           *
    850           * @param       dataInd - data indicate primitive
    851           *
    852           * @return      none
    853           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    854          void INTERP_DataIndication( macMcpsDataInd_t *dataInd )
   \                     INTERP_DataIndication:
    855          {
   \   000000   74F5         MOV     A,#-0xb
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 11
   \   000005                ; Auto size: 64
   \   000005   74C0         MOV     A,#-0x40
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    856            NLDE_FrameFormat_t snff;
    857            aps_FrameFormat_t saff;
    858            zAddrType_t srcAddr;
    859            NLDE_Signal_t sig;
    860          
    861            // parse the Stub NWK header
    862            StubNWK_ParseMsg( dataInd->msdu.p, dataInd->msdu.len, &snff );
   \   00000E   8E82         MOV     DPL,R6
   \   000010   8F83         MOV     DPH,R7
   \   000012   A3           INC     DPTR
   \   000013   A3           INC     DPTR
   \   000014   A3           INC     DPTR
   \   000015   A3           INC     DPTR
   \   000016   E0           MOVX    A,@DPTR
   \   000017   F5..         MOV     ?V0 + 2,A
   \   000019   8E82         MOV     DPL,R6
   \   00001B   8F83         MOV     DPH,R7
   \   00001D   A3           INC     DPTR
   \   00001E   A3           INC     DPTR
   \   00001F   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_10:
   \   000022                ; Setup parameters for call to function osal_memset
   \   000022   7C1F         MOV     R4,#0x1f
   \   000024   7D00         MOV     R5,#0x0
   \   000026   7900         MOV     R1,#0x0
   \   000028   7403         MOV     A,#0x3
   \   00002A   12....       LCALL   ?XSTACK_DISP0_8
   \   00002D   AA82         MOV     R2,DPL
   \   00002F   AB83         MOV     R3,DPH
   \   000031   12....       LCALL   ??osal_memset?relay
   \   000034   7403         MOV     A,#0x3
   \   000036   12....       LCALL   ?XSTACK_DISP0_8
   \   000039   E5..         MOV     A,?V0 + 2
   \   00003B   F0           MOVX    @DPTR,A
   \   00003C                ; Setup parameters for call to function NLDE_ParseFrameControl
   \   00003C   AC82         MOV     R4,DPL
   \   00003E   AD83         MOV     R5,DPH
   \   000040   85..82       MOV     DPL,?V0 + 0
   \   000043   85..83       MOV     DPH,?V0 + 1
   \   000046   E0           MOVX    A,@DPTR
   \   000047   FA           MOV     R2,A
   \   000048   A3           INC     DPTR
   \   000049   E0           MOVX    A,@DPTR
   \   00004A   FB           MOV     R3,A
   \   00004B   12....       LCALL   ??NLDE_ParseFrameControl?relay
   \   00004E   7404         MOV     A,#0x4
   \   000050   12....       LCALL   ?XSTACK_DISP0_8
   \   000053   7402         MOV     A,#0x2
   \   000055   F0           MOVX    @DPTR,A
   \   000056   E5..         MOV     A,?V0 + 0
   \   000058   2402         ADD     A,#0x2
   \   00005A   F8           MOV     R0,A
   \   00005B   E5..         MOV     A,?V0 + 1
   \   00005D   3400         ADDC    A,#0x0
   \   00005F   F9           MOV     R1,A
   \   000060   7420         MOV     A,#0x20
   \   000062   12....       LCALL   ?XSTACK_DISP0_8
   \   000065   E8           MOV     A,R0
   \   000066   F0           MOVX    @DPTR,A
   \   000067   A3           INC     DPTR
   \   000068   E9           MOV     A,R1
   \   000069   F0           MOVX    @DPTR,A
   \   00006A   7403         MOV     A,#0x3
   \   00006C   12....       LCALL   ?XSTACK_DISP0_8
   \   00006F   E0           MOVX    A,@DPTR
   \   000070   24FE         ADD     A,#-0x2
   \   000072   C0E0         PUSH    A
   \   000074   741A         MOV     A,#0x1a
   \   000076   12....       LCALL   ?XSTACK_DISP0_8
   \   000079   D0E0         POP     A
   \   00007B   F0           MOVX    @DPTR,A
    863          
    864            // Fill in MAC destination address
    865            snff.macDstAddr = dataInd->mac.dstAddr.addr.shortAddr;
   \   00007C   EE           MOV     A,R6
   \   00007D   241B         ADD     A,#0x1b
   \   00007F   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_18:
   \   000082   12....       LCALL   ??Subroutine22_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_42:
   \   000085   7410         MOV     A,#0x10
   \   000087   12....       LCALL   ?XSTACK_DISP0_8
   \   00008A   E8           MOV     A,R0
   \   00008B   F0           MOVX    @DPTR,A
   \   00008C   A3           INC     DPTR
   \   00008D   E9           MOV     A,R1
   \   00008E   F0           MOVX    @DPTR,A
    866            
    867            // fill in MAC source address (Stub NWK frame doesn't have address fields)
    868            osal_copyAddress( &srcAddr, (zAddrType_t *)&(dataInd->mac.srcAddr) );
   \   00008F                ; Setup parameters for call to function sAddrCpy
   \   00008F   EE           MOV     A,R6
   \   000090   2412         ADD     A,#0x12
   \   000092   FC           MOV     R4,A
   \   000093   EF           MOV     A,R7
   \   000094   3400         ADDC    A,#0x0
   \   000096   FD           MOV     R5,A
   \   000097   7437         MOV     A,#0x37
   \   000099   12....       LCALL   ?XSTACK_DISP0_8
   \   00009C   AA82         MOV     R2,DPL
   \   00009E   AB83         MOV     R3,DPH
   \   0000A0   12....       LCALL   ??sAddrCpy?relay
    869            
    870            // check if incoming frame is of the right type
    871            if ( snff.frameType != STUB_NWK_FRAME_TYPE )
   \   0000A3   7405         MOV     A,#0x5
   \   0000A5   12....       LCALL   ?XSTACK_DISP0_8
   \   0000A8   E0           MOVX    A,@DPTR
   \   0000A9   6403         XRL     A,#0x3
   \   0000AB   6003         JZ      $+5
   \   0000AD   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    872              return;
    873              
    874            // check if incoming frame is of the right version
    875            if ( snff.protocolVersion != NLME_GetProtocolVersion() )
   \   0000B0                ; Setup parameters for call to function NLME_GetProtocolVersion
   \   0000B0   12....       LCALL   ??NLME_GetProtocolVersion?relay
   \   0000B3   E9           MOV     A,R1
   \   0000B4   FA           MOV     R2,A
   \   0000B5   7406         MOV     A,#0x6
   \   0000B7   12....       LCALL   ?XSTACK_DISP0_8
   \   0000BA   E0           MOVX    A,@DPTR
   \   0000BB   6A           XRL     A,R2
   \   0000BC   6003         JZ      $+5
   \   0000BE   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    876              return;
    877            
    878            // check if the remaining sun-fields are zero
    879            if ( ( snff.discoverRoute != 0 ) || ( snff.multicast != 0 )   ||
    880                 ( snff.secure != 0 )        || ( snff.srcRouteSet != 0 ) ||
    881                 ( snff.dstExtAddrSet != 0 ) || ( snff.srcExtAddrSet != 0 ) )
   \   0000C1   7407         MOV     A,#0x7
   \   0000C3   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C6   E0           MOVX    A,@DPTR
   \   0000C7   6003         JZ      $+5
   \   0000C9   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
   \   0000CC   7408         MOV     A,#0x8
   \   0000CE   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D1   E0           MOVX    A,@DPTR
   \   0000D2   6003         JZ      $+5
   \   0000D4   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
   \   0000D7   7409         MOV     A,#0x9
   \   0000D9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000DC   E0           MOVX    A,@DPTR
   \   0000DD   6003         JZ      $+5
   \   0000DF   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
   \   0000E2   741B         MOV     A,#0x1b
   \   0000E4   12....       LCALL   ?XSTACK_DISP0_8
   \   0000E7   E0           MOVX    A,@DPTR
   \   0000E8   6003         JZ      $+5
   \   0000EA   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
   \   0000ED   740A         MOV     A,#0xa
   \   0000EF   12....       LCALL   ?XSTACK_DISP0_8
   \   0000F2   E0           MOVX    A,@DPTR
   \   0000F3   6003         JZ      $+5
   \   0000F5   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
   \   0000F8   740B         MOV     A,#0xb
   \   0000FA   12....       LCALL   ?XSTACK_DISP0_8
   \   0000FD   E0           MOVX    A,@DPTR
   \   0000FE   6003         JZ      $+5
   \   000100   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    882            {
    883              return;
    884            }
    885            
    886            // parse the Stub APS header
    887            StubAPS_ParseMsg( &snff, &saff );
   \   000103                ; Setup parameters for call to function StubAPS_ParseMsg
   \   000103   7422         MOV     A,#0x22
   \   000105   12....       LCALL   ?XSTACK_DISP0_8
   \   000108   AC82         MOV     R4,DPL
   \   00010A   AD83         MOV     R5,DPH
   \   00010C   7403         MOV     A,#0x3
   \   00010E   12....       LCALL   ?XSTACK_DISP0_8
   \   000111   AA82         MOV     R2,DPL
   \   000113   AB83         MOV     R3,DPH
   \   000115   12....       LCALL   ??StubAPS_ParseMsg?relay
    888          
    889            // check if incoming frame is of the right type
    890            if ( ( saff.FrmCtrl & APS_FRAME_TYPE_MASK ) != STUB_APS_FRAME )
   \   000118   7422         MOV     A,#0x22
   \   00011A   12....       LCALL   ?XSTACK_DISP0_8
   \   00011D   E0           MOVX    A,@DPTR
   \   00011E   5403         ANL     A,#0x3
   \   000120   6403         XRL     A,#0x3
   \   000122   6003         JZ      $+5
   \   000124   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    891              return;
    892             
    893            // check if delivery mode is of the right type
    894            if ( ( saff.FrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_INDIRECT )
   \   000127   E0           MOVX    A,@DPTR
   \   000128   540C         ANL     A,#0xc
   \   00012A   6404         XRL     A,#0x4
   \   00012C   7003         JNZ     $+5
   \   00012E   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    895              return;
    896            
    897            // check if incoming frame is unsecured
    898            if ( saff.FrmCtrl & APS_FC_SECURITY )
   \   000131   E0           MOVX    A,@DPTR
   \   000132   54A0         ANL     A,#0xa0
   \   000134   6003         JZ      $+5
   \   000136   02....       LJMP    ??INTERP_DataIndication_0 & 0xFFFF
    899              return;
    900            
    901            // check if there's no extended header
    902            if ( saff.FrmCtrl & APS_FC_EXTENDED )
    903                return;
    904            
    905            // Set the endpoints
    906            saff.DstEndPoint = appEndPoint;
   \   000139   90....       MOV     DPTR,#appEndPoint
   \   00013C   E0           MOVX    A,@DPTR
   \   00013D   C0E0         PUSH    A
   \   00013F   7424         MOV     A,#0x24
   \   000141   12....       LCALL   ?XSTACK_DISP0_8
   \   000144   D0E0         POP     A
   \   000146   F0           MOVX    @DPTR,A
    907            saff.SrcEndPoint = STUBAPS_INTER_PAN_EP;
   \   000147   7425         MOV     A,#0x25
   \   000149   12....       LCALL   ?XSTACK_DISP0_8
   \   00014C   74FE         MOV     A,#-0x2
   \   00014E   F0           MOVX    @DPTR,A
    908            
    909            // Set the signal strength information
    910            sig.LinkQuality = dataInd->mac.mpduLinkQuality;
   \   00014F   EE           MOV     A,R6
   \   000150   242E         ADD     A,#0x2e
   \   000152   12....       LCALL   ?Subroutine11 & 0xFFFF
   \                     ??CrossCallReturnLabel_28:
   \   000155   85..82       MOV     DPL,?XSP + 0
   \   000158   85..83       MOV     DPH,?XSP + 1
   \   00015B   F0           MOVX    @DPTR,A
    911            sig.correlation = dataInd->mac.correlation;
   \   00015C   EE           MOV     A,R6
   \   00015D   242F         ADD     A,#0x2f
   \   00015F   12....       LCALL   ?Subroutine11 & 0xFFFF
   \                     ??CrossCallReturnLabel_29:
   \   000162   C0E0         PUSH    A
   \   000164   7401         MOV     A,#0x1
   \   000166   12....       LCALL   ?XSTACK_DISP0_8
   \   000169   D0E0         POP     A
   \   00016B   F0           MOVX    @DPTR,A
    912            sig.rssi = dataInd->mac.rssi;
   \   00016C   EE           MOV     A,R6
   \   00016D   2430         ADD     A,#0x30
   \   00016F   12....       LCALL   ?Subroutine11 & 0xFFFF
   \                     ??CrossCallReturnLabel_30:
   \   000172   C0E0         PUSH    A
   \   000174   7402         MOV     A,#0x2
   \   000176   12....       LCALL   ?XSTACK_DISP0_8
   \   000179   D0E0         POP     A
   \   00017B   F0           MOVX    @DPTR,A
    913            
    914            APSDE_DataIndication( &saff, &srcAddr, dataInd->mac.srcPanId, 
    915                                  &sig, FALSE, dataInd->mac.timestamp );
   \   00017C                ; Setup parameters for call to function APSDE_DataIndication
   \   00017C   EE           MOV     A,R6
   \   00017D   2424         ADD     A,#0x24
   \   00017F   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_19:
   \   000182   12....       LCALL   ?PUSH_XSTACK8_X_FOUR
   \   000185   7404         MOV     A,#0x4
   \   000187   12....       LCALL   ?XSTACK_DISP0_8
   \   00018A   8582..       MOV     ?V0 + 0,DPL
   \   00018D   8583..       MOV     ?V0 + 1,DPH
   \   000190   78..         MOV     R0,#?V0 + 0
   \   000192   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000195   EE           MOV     A,R6
   \   000196   242A         ADD     A,#0x2a
   \   000198   12....       LCALL   ?Subroutine12 & 0xFFFF
   \                     ??CrossCallReturnLabel_20:
   \   00019B   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00019E   7900         MOV     R1,#0x0
   \   0001A0   743F         MOV     A,#0x3f
   \   0001A2   12....       LCALL   ?XSTACK_DISP0_8
   \   0001A5   AC82         MOV     R4,DPL
   \   0001A7   AD83         MOV     R5,DPH
   \   0001A9   742A         MOV     A,#0x2a
   \   0001AB   12....       LCALL   ?XSTACK_DISP0_8
   \   0001AE   AA82         MOV     R2,DPL
   \   0001B0   AB83         MOV     R3,DPH
   \   0001B2   12....       LCALL   ??APSDE_DataIndication?relay
   \   0001B5   7408         MOV     A,#0x8
   \   0001B7   12....       LCALL   ?DEALLOC_XSTACK8
    916          
    917          } /* INTERP_DataIndication */
   \                     ??INTERP_DataIndication_0:
   \   0001BA   7440         MOV     A,#0x40
   \   0001BC   02....       LJMP    ?Subroutine15 & 0xFFFF

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for StubAPS_TaskID>`:
   \   000000   FF           DB 255

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for appTaskID>`:
   \   000000   FF           DB 255

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_ParseMsg?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_ParseMsg

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_BuildFrameControl?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_BuildFrameControl

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_BuildMsg?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_BuildMsg

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_SetNewChannel?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_SetNewChannel

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_SetInterPanChannel?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_SetInterPanChannel

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_SetIntraPanChannel?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_SetIntraPanChannel

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_InterPan?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_InterPan

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_RegisterApp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_RegisterApp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??StubAPS_ZMacCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    StubAPS_ZMacCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??INTERP_DataReq?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    INTERP_DataReq

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??INTERP_DataReqMTU?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    INTERP_DataReqMTU

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??INTERP_DataConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    INTERP_DataConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??INTERP_DataIndication?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    INTERP_DataIndication
    918          
    919          
    920          /*********************************************************************
    921          *********************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     INTERP_DataConfirm                 2      0     13
       -> afDataConfirm                 4      0      0
     INTERP_DataIndication              1      0     96
       -> osal_memset                   0      0    150
       -> NLDE_ParseFrameControl        0      0    150
       -> sAddrCpy                      0      0    150
       -> NLME_GetProtocolVersion       0      0    150
       -> StubAPS_ParseMsg              0      0    150
       -> APSDE_DataIndication          0      0    166
     INTERP_DataReq                     1      0     53
       -> StubAPS_InterPan              0      0     98
       -> osal_memset                   0      0     98
       -> StubAPS_BuildFrameControl     0      0    106
       -> osal_mem_alloc                0      0     98
       -> StubAPS_BuildMsg              0      0    102
       -> NLME_GetProtocolVersion       0      0     98
       -> ZMacDataReq                   0      0     98
       -> osal_mem_free                 0      0     98
     INTERP_DataReqMTU                  0      0      0
     StubAPS_BuildFrameControl          1      0     66
       -> sAddrExtCpy                   0      0     26
     StubAPS_BuildMsg                   1      0     65
       -> osal_memcpy                   0      0     28
     StubAPS_Init                       2      0      0
     StubAPS_InterPan                   0      0     59
       -> ZMacGetReq                    0      0     20
     StubAPS_ParseMsg                   1      0     89
       -> osal_memset                   0      0     28
     StubAPS_ProcessEvent               1      0     13
       -> StubAPS_SetNewChannel         0      0     26
       -> ZMacSetReq                    0      0     26
       -> nwk_setStateIdle              0      0     26
       -> osal_msg_allocate             0      0     26
       -> osal_msg_send                 0      0     26
       -> INTERP_DataIndication         0      0     26
       -> osal_msg_deallocate           0      0     26
       -> osal_msg_receive              0      0     26
       -> INTERP_DataConfirm            0      0     26
     StubAPS_RegisterApp                2      0      0
     StubAPS_SetInterPanChannel         1      0     11
       -> ZMacGetReq                    0      0     22
       -> nwk_setStateIdle              0      0     22
       -> ZMacSetReq                    0      0     22
       -> StubAPS_SetNewChannel         0      0     22
       -> osal_start_timerEx            0      0     22
     StubAPS_SetIntraPanChannel         3      0      2
       -> ZMacGetReq                    4      0      4
       -> ZMacSetReq                    4      0      4
       -> ZMacSetReq                    4      0      4
       -> ZMacSetReq                    4      0      4
       -> nwk_setStateIdle              4      0      4
     StubAPS_SetNewChannel              3      0     15
       -> nwkDB_CountTypes              4      0      4
       -> ZMacStateIdle                 4      0      4
       -> ZMacSetReq                    4      0      4
       -> ZMacSetReq                    4      0      4
     StubAPS_ZMacCallback               2      0      0
       -> osal_msg_send                 4      0      0


   Segment part sizes:

     Function/Label                     Bytes
     --------------                     -----
     StubAPS_TaskID                        1
     newChannel                            1
     channelChangeInProgress               1
     appTaskID                             1
     appEndPoint                           1
     StubAPS_Init                         22
     ??Subroutine21_0                      7
     StubAPS_ProcessEvent                165
     ?Subroutine13                        17
     ?Subroutine1                         16
     StubAPS_ParseMsg                    248
     ?Subroutine4                         18
     ?Subroutine0                          2
     ??Subroutine17_0                     19
     ?Subroutine10                        12
     ??Subroutine19_0                      7
     ??Subroutine22_0                      6
     ?Subroutine12                         8
     StubAPS_BuildFrameControl           198
     ?Subroutine3                         11
     ??Subroutine18_0                      6
     ?Subroutine8                          4
     ?Subroutine7                         10
     StubAPS_BuildMsg                     99
     ?Subroutine15                         8
     ?Subroutine11                         3
     ?Subroutine6                          8
     ?Subroutine5                         19
     StubAPS_SetNewChannel                62
     ??Subroutine20_0                      4
     ?Subroutine14                         5
     StubAPS_SetInterPanChannel           95
     ?Subroutine16                         8
     ?Subroutine2                          1
     StubAPS_SetIntraPanChannel           75
     StubAPS_InterPan                     81
     StubAPS_RegisterApp                  27
     ?Subroutine9                         10
     StubAPS_ZMacCallback                 74
     INTERP_DataReq                      403
     INTERP_DataReqMTU                     5
     INTERP_DataConfirm                   34
     INTERP_DataIndication               447
     ?<Initializer for StubAPS_TaskID>     1
     ?<Initializer for appTaskID>          1
     ??StubAPS_Init?relay                  6
     ??StubAPS_ProcessEvent?relay          6
     ??StubAPS_ParseMsg?relay              6
     ??StubAPS_BuildFrameControl?relay     6
     ??StubAPS_BuildMsg?relay              6
     ??StubAPS_SetNewChannel?relay         6
     ??StubAPS_SetInterPanChannel?relay    6
     ??StubAPS_SetIntraPanChannel?relay    6
     ??StubAPS_InterPan?relay              6
     ??StubAPS_RegisterApp?relay           6
     ??StubAPS_ZMacCallback?relay          6
     ??INTERP_DataReq?relay                6
     ??INTERP_DataReqMTU?relay             6
     ??INTERP_DataConfirm?relay            6
     ??INTERP_DataIndication?relay         6

 
 2 244 bytes in segment BANKED_CODE
    90 bytes in segment BANK_RELAYS
     2 bytes in segment XDATA_I
     2 bytes in segment XDATA_ID
     3 bytes in segment XDATA_Z
 
 2 336 bytes of CODE  memory
     5 bytes of XDATA memory

Errors: none
Warnings: none
